<!doctype html>
<html lang="zh">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>TensorFlowé«˜çº§åº”ç”¨ // Yaku Makki</title>
    <link rel="shortcut icon" href="./assets/avatar/avatar.jpg" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.151.2">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Yaku Makki" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.422840b4454cb211f5b3dab61f082cdff508e88825173c31806835cb75529734.css" />
    

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="TensorFlowé«˜çº§åº”ç”¨">
  <meta name="twitter:description" content="TensorFlowé«˜çº§åº”ç”¨ æœ¬ç« ä»‹ç»TensorFlowåœ¨å®žé™…é¡¹ç›®ä¸­çš„é«˜çº§åº”ç”¨ï¼ŒåŒ…æ‹¬è®¡ç®—æœºè§†è§‰ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€å¼ºåŒ–å­¦ä¹ ã€æ¨¡åž‹éƒ¨ç½²ç­‰é¢†åŸŸçš„å®Œæ•´è§£å†³æ–¹æ¡ˆå’Œæœ€ä½³å®žè·µã€‚
ðŸŽ¨ è®¡ç®—æœºè§†è§‰åº”ç”¨ ç›®æ ‡æ£€æµ‹ - YOLOå®žçŽ° import tensorflow as tf import numpy as np import cv2 def create_yolo_model(num_classes, input_shape=(416, 416, 3)): &#34;&#34;&#34;åˆ›å»ºYOLOæ¨¡åž‹&#34;&#34;&#34; inputs = tf.keras.Input(shape=input_shape) # ç‰¹å¾æå–ç½‘ç»œ x = tf.keras.layers.Conv2D(32, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(inputs) x = tf.keras.layers.BatchNormalization()(x) x = tf.keras.layers.MaxPooling2D(pool_size=2)(x) x = tf.keras.layers.Conv2D(64, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) x = tf.keras.layers.BatchNormalization()(x) x = tf.keras.layers.MaxPooling2D(pool_size=2)(x) x = tf.keras.layers.Conv2D(128, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) x = tf.keras.layers.BatchNormalization()(x) x = tf.keras.layers.MaxPooling2D(pool_size=2)(x) # æ£€æµ‹å¤´ x = tf.keras.layers.Conv2D(256, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) x = tf.keras.layers.Conv2D(512, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) # è¾“å‡ºå±‚ï¼šè¾¹ç•Œæ¡†ã€ç½®ä¿¡åº¦å’Œç±»åˆ«é¢„æµ‹ output = tf.keras.layers.Conv2D( num_classes &#43; 5, 1, strides=1, padding=&#39;same&#39;, activation=&#39;linear&#39; )(x) return tf.keras.Model(inputs=inputs, outputs=output) # YOLOæŸå¤±å‡½æ•° class YOLOLoss(tf.keras.losses.Loss): def __init__(self, num_classes, grid_size=13, **kwargs): super(YOLOLoss, self).__init__(**kwargs) self.num_classes = num_classes self.grid_size = grid_size def call(self, y_true, y_pred): # å®žçŽ°YOLOæŸå¤±å‡½æ•° # åŒ…æ‹¬è¾¹ç•Œæ¡†å›žå½’æŸå¤±ã€ç½®ä¿¡åº¦æŸå¤±å’Œåˆ†ç±»æŸå¤± return total_loss # åˆ›å»ºå’Œè®­ç»ƒYOLOæ¨¡åž‹ model = create_yolo_model(num_classes=20) model.compile( optimizer=tf.keras.optimizers.Adam(learning_rate=0.001), loss=YOLOLoss(num_classes=20), metrics=[&#39;accuracy&#39;] ) å›¾åƒåˆ†å‰² - U-Netå®žçŽ° def create_unet_model(input_shape=(256, 256, 3), num_classes=1): &#34;&#34;&#34;åˆ›å»ºU-Netæ¨¡åž‹&#34;&#34;&#34; inputs = tf.keras.Input(shape=input_shape) # ç¼–ç å™¨ c1 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(inputs) c1 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c1) p1 = tf.keras.layers.MaxPooling2D(pool_size=2)(c1) c2 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(p1) c2 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c2) p2 = tf.keras.layers.MaxPooling2D(pool_size=2)(c2) c3 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(p2) c3 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c3) p3 = tf.keras.layers.MaxPooling2D(pool_size=2)(c3) # ç“¶é¢ˆå±‚ c4 = tf.keras.layers.Conv2D(512, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(p3) c4 = tf.keras.layers.Conv2D(512, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c4) # è§£ç å™¨ u5 = tf.keras.layers.Conv2DTranspose(256, 2, strides=2, padding=&#39;same&#39;)(c4) u5 = tf.keras.layers.concatenate([u5, c3]) c5 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(u5) c5 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c5) u6 = tf.keras.layers.Conv2DTranspose(128, 2, strides=2, padding=&#39;same&#39;)(c5) u6 = tf.keras.layers.concatenate([u6, c2]) c6 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(u6) c6 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c6) u7 = tf.keras.layers.Conv2DTranspose(64, 2, strides=2, padding=&#39;same&#39;)(c6) u7 = tf.keras.layers.concatenate([u7, c1]) c7 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(u7) c7 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c7) # è¾“å‡ºå±‚ outputs = tf.keras.layers.Conv2D(num_classes, 1, activation=&#39;sigmoid&#39;)(c7) return tf.keras.Model(inputs=inputs, outputs=outputs) # DiceæŸå¤±å‡½æ•° def dice_loss(y_true, y_pred): smooth = 1e-15 intersection = tf.reduce_sum(y_true * y_pred) union = tf.reduce_sum(y_true) &#43; tf.reduce_sum(y_pred) dice = (2.0 * intersection &#43; smooth) / (union &#43; smooth) return 1.0 - dice # åˆ›å»ºå’Œè®­ç»ƒU-Net model = create_unet_model() model.compile( optimizer=tf.keras.optimizers.Adam(learning_rate=0.001), loss=dice_loss, metrics=[tf.keras.metrics.MeanIoU(num_classes=2)] ) ðŸ“ è‡ªç„¶è¯­è¨€å¤„ç†åº”ç”¨ Transformeræ¨¡åž‹å®žçŽ° class TransformerModel(tf.keras.Model): def __init__(self, vocab_size, d_model, num_heads, num_layers, d_ff, max_len): super(TransformerModel, self).__init__() self.embedding = tf.keras.layers.Embedding(vocab_size, d_model) self.pos_encoding = self.positional_encoding(max_len, d_model) self.encoder_layers = [ self.encoder_layer(d_model, num_heads, d_ff) for _ in range(num_layers) ] self.decoder_layers = [ self.decoder_layer(d_model, num_heads, d_ff) for _ in range(num_layers) ] self.final_layer = tf.keras.layers.Dense(vocab_size) def positional_encoding(self, max_len, d_model): pos = tf.range(max_len, dtype=tf.float32)[:, tf.newaxis] i = tf.range(d_model, dtype=tf.float32)[tf.newaxis, :] angle_rates = 1 / tf.pow(10000, (2 * (i // 2)) / tf.cast(d_model, tf.float32)) angle_rads = pos * angle_rates angle_rads = tf.where(i % 2 == 0, tf.sin(angle_rads), tf.cos(angle_rads)) return angle_rads[tf.newaxis, ...] def encoder_layer(self, d_model, num_heads, d_ff): inputs = tf.keras.Input(shape=(None, d_model)) # å¤šå¤´æ³¨æ„åŠ› attn_output = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(inputs, inputs) attn_output = tf.keras.layers.Dropout(0.1)(attn_output) out1 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(inputs &#43; attn_output) # å‰é¦ˆç½‘ç»œ ffn_output = tf.keras.layers.Dense(d_ff, activation=&#39;relu&#39;)(out1) ffn_output = tf.keras.layers.Dense(d_model)(ffn_output) ffn_output = tf.keras.layers.Dropout(0.1)(ffn_output) out2 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out1 &#43; ffn_output) return tf.keras.Model(inputs=inputs, outputs=out2) def decoder_layer(self, d_model, num_heads, d_ff): inputs = tf.keras.Input(shape=(None, d_model)) enc_output = tf.keras.Input(shape=(None, d_model)) # æŽ©ç å¤šå¤´æ³¨æ„åŠ› attn1 = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(inputs, inputs) attn1 = tf.keras.layers.Dropout(0.1)(attn1) out1 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(inputs &#43; attn1) # ç¼–ç å™¨-è§£ç å™¨æ³¨æ„åŠ› attn2 = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(out1, enc_output) attn2 = tf.keras.layers.Dropout(0.1)(attn2) out2 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out1 &#43; attn2) # å‰é¦ˆç½‘ç»œ ffn_output = tf.keras.layers.Dense(d_ff, activation=&#39;relu&#39;)(out2) ffn_output = tf.keras.layers.Dense(d_model)(ffn_output) ffn_output = tf.keras.layers.Dropout(0.1)(ffn_output) out3 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out2 &#43; ffn_output) return tf.keras.Model(inputs=[inputs, enc_output], outputs=out3) def call(self, inputs, targets=None, training=False): # è¯åµŒå…¥ &#43; ä½ç½®ç¼–ç  x = self.embedding(inputs) x *= tf.math.sqrt(tf.cast(tf.shape(x)[-1], tf.float32)) x &#43;= self.pos_encoding[:, :tf.shape(x)[1], :] # ç¼–ç å™¨ enc_output = x for layer in self.encoder_layers: enc_output = layer(enc_output) # è§£ç å™¨ if targets is not None: y = self.embedding(targets) y *= tf.math.sqrt(tf.cast(tf.shape(y)[-1], tf.float32)) y &#43;= self.pos_encoding[:, :tf.shape(y)[1], :] for layer in self.decoder_layers: y = layer([y, enc_output]) outputs = self.final_layer(y) else: outputs = None return outputs, enc_output # åˆ›å»ºTransformeræ¨¡åž‹ model = TransformerModel( vocab_size=10000, d_model=512, num_heads=8, num_layers=6, d_ff=2048, max_len=100 ) BERTé¢„è®­ç»ƒæ¨¡åž‹ class BERTModel(tf.keras.Model): def __init__(self, vocab_size, d_model, num_heads, num_layers, d_ff, max_len): super(BERTModel, self).__init__() self.embedding = tf.keras.layers.Embedding(vocab_size, d_model) self.pos_encoding = self.positional_encoding(max_len, d_model) self.segment_embedding = tf.keras.layers.Embedding(2, d_model) self.transformer_layers = [ self.transformer_layer(d_model, num_heads, d_ff) for _ in range(num_layers) ] self.mlm_head = tf.keras.layers.Dense(vocab_size, activation=&#39;softmax&#39;) self.nsp_head = tf.keras.layers.Dense(2, activation=&#39;softmax&#39;) def transformer_layer(self, d_model, num_heads, d_ff): inputs = tf.keras.Input(shape=(None, d_model)) # å¤šå¤´æ³¨æ„åŠ› attn_output = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(inputs, inputs) attn_output = tf.keras.layers.Dropout(0.1)(attn_output) out1 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(inputs &#43; attn_output) # å‰é¦ˆç½‘ç»œ ffn_output = tf.keras.layers.Dense(d_ff, activation=&#39;relu&#39;)(out1) ffn_output = tf.keras.layers.Dense(d_model)(ffn_output) ffn_output = tf.keras.layers.Dropout(0.1)(ffn_output) out2 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out1 &#43; ffn_output) return tf.keras.Model(inputs=inputs, outputs=out2) def call(self, inputs, segment_ids=None, masked_positions=None): # è¯åµŒå…¥ &#43; ä½ç½®ç¼–ç  &#43; æ®µç¼–ç  x = self.embedding(inputs) x &#43;= self.pos_encoding[:, :tf.shape(x)[1], :] if segment_ids is not None: x &#43;= self.segment_embedding(segment_ids) # Transformerå±‚ for layer in self.transformer_layers: x = layer(x) # æŽ©ç è¯­è¨€æ¨¡åž‹é¢„æµ‹ if masked_positions is not None: masked_outputs = tf.gather(x, masked_positions, axis=1, batch_dims=1) mlm_logits = self.mlm_head(masked_outputs) else: mlm_logits = None # ä¸‹ä¸€å¥é¢„æµ‹ cls_token = x[:, 0, :] # [CLS] token nsp_logits = self.nsp_head(cls_token) return mlm_logits, nsp_logits # åˆ›å»ºBERTæ¨¡åž‹ bert_model = BERTModel( vocab_size=30000, d_model=768, num_heads=12, num_layers=12, d_ff=3072, max_len=512 ) ðŸŽ® å¼ºåŒ–å­¦ä¹ åº”ç”¨ DQNå®žçŽ° import tensorflow as tf import numpy as np import random from collections import deque class DQNAgent: def __init__(self, state_size, action_size): self.state_size = state_size self.action_size = action_size self.memory = deque(maxlen=2000) self.gamma = 0.95 # æŠ˜æ‰£å› å­ self.epsilon = 1.0 # æŽ¢ç´¢çŽ‡ self.epsilon_min = 0.01 self.epsilon_decay = 0.995 self.learning_rate = 0.001 self.model = self._build_model() self.target_model = self._build_model() self.update_target_model() def _build_model(self): &#34;&#34;&#34;æž„å»ºDQNç½‘ç»œ&#34;&#34;&#34; model = tf.keras.Sequential([ tf.keras.layers.Dense(24, input_dim=self.state_size, activation=&#39;relu&#39;), tf.keras.layers.Dense(24, activation=&#39;relu&#39;), tf.keras.layers.Dense(self.action_size, activation=&#39;linear&#39;) ]) model.compile( optimizer=tf.keras.optimizers.Adam(learning_rate=self.learning_rate), loss=&#39;mse&#39; ) return model def update_target_model(self): &#34;&#34;&#34;æ›´æ–°ç›®æ ‡ç½‘ç»œ&#34;&#34;&#34; self.target_model.set_weights(self.model.get_weights()) def remember(self, state, action, reward, next_state, done): &#34;&#34;&#34;å­˜å‚¨ç»éªŒ&#34;&#34;&#34; self.memory.append((state, action, reward, next_state, done)) def act(self, state): &#34;&#34;&#34;é€‰æ‹©åŠ¨ä½œ&#34;&#34;&#34; if np.random.rand() &lt;= self.epsilon: return random.randrange(self.action_size) # éšæœºæŽ¢ç´¢ act_values = self.model.predict(state, verbose=0) return np.argmax(act_values[0]) # åˆ©ç”¨ def replay(self, batch_size): &#34;&#34;&#34;ç»éªŒå›žæ”¾&#34;&#34;&#34; minibatch = random.sample(self.memory, batch_size) for state, action, reward, next_state, done in minibatch: target = self.model.predict(state, verbose=0) if done: target[0][action] = reward else: t = self.target_model.predict(next_state, verbose=0) target[0][action] = reward &#43; self.gamma * np.amax(t[0]) self.model.fit(state, target, epochs=1, verbose=0) if self.epsilon &gt; self.epsilon_min: self.epsilon *= self.epsilon_decay # ä½¿ç”¨DQNä»£ç† env = gym.make(&#39;CartPole-v1&#39;) state_size = env.observation_space.shape[0] action_size = env.action_space.n agent = DQNAgent(state_size, action_size) # è®­ç»ƒDQN episodes = 1000 batch_size = 32 for e in range(episodes): state = env.reset() state = np.reshape(state, [1, state_size]) for time in range(500): action = agent.act(state) next_state, reward, done, _ = env.step(action) next_state = np.reshape(next_state, [1, state_size]) agent.remember(state, action, reward, next_state, done) state = next_state if done: agent.update_target_model() print(f&#34;Episode: {e}/{episodes}, Score: {time}&#34;) break if len(agent.memory) &gt; batch_size: agent.replay(batch_size) PPOå®žçŽ° class PPOAgent: def __init__(self, state_size, action_size, clip_ratio=0.2): self.state_size = state_size self.action_size = action_size self.clip_ratio = clip_ratio # Actorç½‘ç»œ self.actor = self._build_actor() # Criticç½‘ç»œ self.critic = self._build_critic() self.actor_optimizer = tf.keras.optimizers.Adam(learning_rate=0.0003) self.critic_optimizer = tf.keras.optimizers.Adam(learning_rate=0.001) def _build_actor(self): &#34;&#34;&#34;æž„å»ºç­–ç•¥ç½‘ç»œ&#34;&#34;&#34; inputs = tf.keras.Input(shape=(self.state_size,)) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(inputs) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(x) outputs = tf.keras.layers.Dense(self.action_size, activation=&#39;softmax&#39;)(x) return tf.keras.Model(inputs=inputs, outputs=outputs) def _build_critic(self): &#34;&#34;&#34;æž„å»ºä»·å€¼ç½‘ç»œ&#34;&#34;&#34; inputs = tf.keras.Input(shape=(self.state_size,)) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(inputs) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(x) outputs = tf.keras.layers.Dense(1)(x) return tf.keras.Model(inputs=inputs, outputs=outputs) def get_action(self, state): &#34;&#34;&#34;èŽ·å–åŠ¨ä½œ&#34;&#34;&#34; state = np.reshape(state, [1, self.state_size]) probs = self.actor.predict(state, verbose=0)[0] action = np.random.choice(self.action_size, p=probs) return action, probs[action] def compute_advantages(self, rewards, values, next_values, dones): &#34;&#34;&#34;è®¡ç®—ä¼˜åŠ¿å‡½æ•°&#34;&#34;&#34; advantages = np.zeros_like(rewards) last_gae_lam = 0 for t in reversed(range(len(rewards))): if t == len(rewards) - 1: next_non_terminal = 1.0 - dones[t] next_values = next_values[t] else: next_non_terminal = 1.0 - dones[t] next_values = values[t &#43; 1] delta = rewards[t] &#43; 0.99 * next_values * next_non_terminal - values[t] advantages[t] = last_gae_lam = delta &#43; 0.99 * 0.95 * next_non_terminal * last_gae_lam return advantages def train(self, states, actions, old_probs, advantages, returns): &#34;&#34;&#34;PPOè®­ç»ƒ&#34;&#34;&#34; with tf.GradientTape() as tape: probs = self.actor(states) values = self.critic(states) # è®¡ç®—ç­–ç•¥æŸå¤± new_probs = tf.gather(probs, actions, axis=1, batch_dims=1) ratio = new_probs / old_probs clipped_ratio = tf.clip_by_value(ratio, 1 - self.clip_ratio, 1 &#43; self.clip_ratio) policy_loss = -tf.reduce_mean(tf.minimum(ratio * advantages, clipped_ratio * advantages)) # è®¡ç®—ä»·å€¼æŸå¤± value_loss = tf.reduce_mean(tf.square(returns - values)) # æ€»æŸå¤± loss = policy_loss &#43; 0.5 * value_loss # æ›´æ–°Actor actor_grads = tape.gradient(policy_loss, self.actor.trainable_variables) self.actor_optimizer.apply_gradients(zip(actor_grads, self.actor.trainable_variables)) # æ›´æ–°Critic critic_grads = tape.gradient(value_loss, self.critic.trainable_variables) self.critic_optimizer.apply_gradients(zip(critic_grads, self.critic.trainable_variables)) return loss ðŸš€ æ¨¡åž‹éƒ¨ç½² TensorFlow Serving # ä¿å­˜æ¨¡åž‹ç”¨äºŽServing import tensorflow as tf # åˆ›å»ºæ¨¡åž‹ model = tf.keras.Sequential([ tf.keras.layers.Dense(64, activation=&#39;relu&#39;, input_shape=(10,)), tf.keras.layers.Dense(1, activation=&#39;sigmoid&#39;) ]) # è®­ç»ƒæ¨¡åž‹ï¼ˆç¤ºä¾‹ï¼‰ # model.fit(...) # ä¿å­˜æ¨¡åž‹ model.save(&#39;model/1&#39;) # TensorFlow Servingæ ¼å¼ # å¯åŠ¨TensorFlow Serving &#34;&#34;&#34; tensorflow_model_server \ --rest_api_port=8501 \ --model_name=my_model \ --model_base_path=/path/to/model &#34;&#34;&#34; # ä½¿ç”¨REST APIè¿›è¡Œé¢„æµ‹ import requests import json data = json.dumps({ &#34;signature_name&#34;: &#34;serving_default&#34;, &#34;inputs&#34;: { &#34;dense_input&#34;: [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]] } }) headers = {&#34;content-type&#34;: &#34;application/json&#34;} response = requests.post(&#39;http://localhost:8501/v1/models/my_model:predict&#39;, data=data, headers=headers) print(response.json()) TensorFlow Liteè½¬æ¢å’Œéƒ¨ç½² # è½¬æ¢ä¸ºTensorFlow Lite def convert_to_tflite(model, quantization=&#39;float32&#39;): &#34;&#34;&#34;è½¬æ¢ä¸ºTensorFlow Liteæ ¼å¼&#34;&#34;&#34; # åˆ›å»ºè½¬æ¢å™¨ converter = tf.lite.TFLiteConverter.from_keras_model(model) if quantization == &#39;float16&#39;: converter.optimizations = [tf.lite.Optimize.DEFAULT] converter.target_spec.supported_types = [tf.float16] elif quantization == &#39;int8&#39;: converter.optimizations = [tf.lite.Optimize.DEFAULT] # æä¾›ä»£è¡¨æ€§æ•°æ®é›†ç”¨äºŽé‡åŒ– def representative_data_gen(): for input_value in tf.data.Dataset.from_tensor_slices(x_train).batch(1).take(100): yield [input_value] converter.representative_dataset = representative_data_gen converter.target_spec.supported_ops = [tf.lite.OpsSet.TFLITE_BUILTINS_INT8] converter.inference_input_type = tf.int8 converter.inference_output_type = tf.int8 # è½¬æ¢æ¨¡åž‹ tflite_model = converter.convert() # ä¿å­˜æ¨¡åž‹ with open(f&#39;model_{quantization}.tflite&#39;, &#39;wb&#39;) as f: f.write(tflite_model) return tflite_model # è½¬æ¢ä¸åŒç²¾åº¦ç‰ˆæœ¬ model = create_model() # å‡è®¾çš„æ¨¡åž‹åˆ›å»ºå‡½æ•° # è½¬æ¢ä¸ºä¸åŒç²¾åº¦ convert_to_tflite(model, &#39;float32&#39;) convert_to_tflite(model, &#39;float16&#39;) convert_to_tflite(model, &#39;int8&#39;) # è¯„ä¼°æ¨¡åž‹å¤§å°å’Œæ€§èƒ½ import os for precision in [&#39;float32&#39;, &#39;float16&#39;, &#39;int8&#39;]: model_path = f&#39;model_{precision}.tflite&#39; if os.path.exists(model_path): size = os.path.getsize(model_path) / 1024 / 1024 # MB print(f&#34;{precision}æ¨¡åž‹å¤§å°: {size:.2f} MB&#34;) TensorFlow.jsè½¬æ¢ # è½¬æ¢ä¸ºTensorFlow.jsæ ¼å¼ import tensorflowjs as tfjs # ä¿å­˜ä¸ºTensorFlow.jsæ ¼å¼ tfjs.converters.save_keras_model(model, &#39;tfjs_model/&#39;) # æˆ–è€…è½¬æ¢ä¸ºåˆ†å±‚æ ¼å¼ tfjs.converters.save_keras_model(model, &#39;tfjs_model/&#39;, quantization_dtype=tfjs.quantization_config.INT8) # HTMLä¸­ä½¿ç”¨æ¨¡åž‹ &#34;&#34;&#34; &lt;html&gt; &lt;head&gt; &lt;script src=&#34;https://cdn.jsdelivr.net/npm/@tensorflow/tfjs&#34;&gt;&lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;script&gt; async function loadModel() { // åŠ è½½æ¨¡åž‹ const model = await tf.loadLayersModel(&#39;tfjs_model/model.json&#39;); // å‡†å¤‡è¾“å…¥æ•°æ® const input = tf.tensor2d([[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]]); // è¿›è¡Œé¢„æµ‹ const prediction = model.predict(input); prediction.print(); } loadModel(); &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; &#34;&#34;&#34; ðŸ“Š ç”Ÿäº§çŽ¯å¢ƒæœ€ä½³å®žè·µ æ¨¡åž‹ç›‘æŽ§ class ModelMonitor: def __init__(self, model, metrics=[&#39;accuracy&#39;, &#39;latency&#39;, &#39;throughput&#39;]): self.model = model self.metrics = metrics self.predictions = [] self.true_labels = [] self.latencies = [] def predict_with_monitoring(self, inputs, true_labels=None): &#34;&#34;&#34;å¸¦ç›‘æŽ§çš„é¢„æµ‹&#34;&#34;&#34; import time start_time = time.time() # è¿›è¡Œé¢„æµ‹ predictions = self.model.predict(inputs) end_time = time.time() latency = end_time - start_time # è®°å½•æŒ‡æ ‡ self.latencies.append(latency) self.predictions.extend(predictions) if true_labels is not None: self.true_labels.extend(true_labels) return predictions def generate_report(self): &#34;&#34;&#34;ç”Ÿæˆç›‘æŽ§æŠ¥å‘Š&#34;&#34;&#34; report = {} if self.latencies: report[&#39;avg_latency&#39;] = np.mean(self.latencies) report[&#39;p95_latency&#39;] = np.percentile(self.latencies, 95) report[&#39;throughput&#39;] = len(self.latencies) / sum(self.latencies) if self.true_labels and self.predictions: predictions = np.array(self.predictions) true_labels = np.array(self.true_labels) if len(predictions.shape) &gt; 1: pred_classes = np.argmax(predictions, axis=1) true_classes = np.argmax(true_labels, axis=1) else: pred_classes = (predictions &gt; 0.5).astype(int) true_classes = true_labels report[&#39;accuracy&#39;] = np.mean(pred_classes == true_classes) return report # ä½¿ç”¨æ¨¡åž‹ç›‘æŽ§ monitor = ModelMonitor(model) # æ¨¡æ‹Ÿç”Ÿäº§çŽ¯å¢ƒé¢„æµ‹ for i in range(100): test_input = np.random.rand(1, 10) true_label = np.random.randint(0, 2, 1) prediction = monitor.predict_with_monitoring(test_input, true_label) # ç”ŸæˆæŠ¥å‘Š report = monitor.generate_report() print(&#34;æ¨¡åž‹ç›‘æŽ§æŠ¥å‘Š:&#34;, report) A/Bæµ‹è¯•æ¡†æž¶ class ABTestFramework: def __init__(self, model_a, model_b, traffic_split=0.5): self.model_a = model_a self.model_b = model_b self.traffic_split = traffic_split self.model_a_metrics = [] self.model_b_metrics = [] def predict(self, inputs, true_labels=None): &#34;&#34;&#34;A/Bæµ‹è¯•é¢„æµ‹&#34;&#34;&#34; results = [] for i, (input_data, true_label) in enumerate(zip(inputs, true_labels or [])): # éšæœºåˆ†é…æµé‡ if np.random.random() &lt; self.traffic_split: model = self.model_a model_name = &#39;A&#39; else: model = self.model_b model_name = &#39;B&#39; # è¿›è¡Œé¢„æµ‹ prediction = model.predict(np.expand_dims(input_data, 0))[0] results.append({ &#39;model&#39;: model_name, &#39;prediction&#39;: prediction, &#39;true_label&#39;: true_label }) return results def evaluate_models(self, results): &#34;&#34;&#34;è¯„ä¼°æ¨¡åž‹æ€§èƒ½&#34;&#34;&#34; model_a_results = [r for r in results if r[&#39;model&#39;] == &#39;A&#39;] model_b_results = [r for r in results if r[&#39;model&#39;] == &#39;B&#39;] def calculate_metrics(results): if not results: return {} predictions = np.array([r[&#39;prediction&#39;] for r in results]) true_labels = np.array([r[&#39;true_label&#39;] for r in results]) pred_classes = np.argmax(predictions, axis=1) true_classes = np.argmax(true_labels, axis=1) accuracy = np.mean(pred_classes == true_classes) return {&#39;accuracy&#39;: accuracy, &#39;sample_size&#39;: len(results)} metrics_a = calculate_metrics(model_a_results) metrics_b = calculate_metrics(model_b_results) return {&#39;model_a&#39;: metrics_a, &#39;model_b&#39;: metrics_b} # ä½¿ç”¨A/Bæµ‹è¯•æ¡†æž¶ ab_test = ABTestFramework(model_v1, model_v2, traffic_split=0.5) # æ¨¡æ‹ŸA/Bæµ‹è¯• test_inputs = [np.random.rand(10) for _ in range(1000)] test_labels = [np.random.randint(0, 2, 10) for _ in range(1000)] results = ab_test.predict(test_inputs, test_labels) metrics = ab_test.evaluate_models(results) print(&#34;A/Bæµ‹è¯•ç»“æžœ:&#34;, metrics) ðŸ“š å­¦ä¹ èµ„æº å®˜æ–¹æ–‡æ¡£ TensorFlow Servingæ–‡æ¡£ TensorFlow Liteæ–‡æ¡£ TensorFlow.jsæ–‡æ¡£ å´æ©è¾¾è¯¾ç¨‹ æ·±åº¦å­¦ä¹ è¯¾ç¨‹ä¸­å…³äºŽå®žé™…åº”ç”¨çš„éƒ¨åˆ† ç»å…¸é¡¹ç›® TensorFlow Models - å®˜æ–¹æ¨¡åž‹åº“ TensorFlow Hub - é¢„è®­ç»ƒæ¨¡åž‹ä»“åº“ Kaggleç«žèµ› - å®žè·µé¡¹ç›® ðŸ”§ éƒ¨ç½²æœ€ä½³å®žè·µ å®¹å™¨åŒ–éƒ¨ç½² # Dockerfile FROM tensorflow/serving:latest COPY model/ /models/my_model ENV MODEL_NAME=my_model # å¯åŠ¨å‘½ä»¤ CMD [&#34;tensorflow_model_server&#34;, &#34;--rest_api_port=8501&#34;, &#34;--model_name=my_model&#34;, &#34;--model_base_path=/models/my_model&#34;] æ¨¡åž‹ç‰ˆæœ¬ç®¡ç† # æ¨¡åž‹ç‰ˆæœ¬ç®¡ç† import tensorflow as tf class ModelVersionManager: def __init__(self, model_base_path): self.model_base_path = model_base_path self.versions = {} def save_model_version(self, model, version, metadata=None): &#34;&#34;&#34;ä¿å­˜æ¨¡åž‹ç‰ˆæœ¬&#34;&#34;&#34; version_path = f&#34;{self.model_base_path}/{version}&#34; # ä¿å­˜æ¨¡åž‹ model.save(version_path) # ä¿å­˜å…ƒæ•°æ® if metadata: with open(f&#34;{version_path}/metadata.json&#34;, &#39;w&#39;) as f: json.dump(metadata, f) self.versions[version] = { &#39;path&#39;: version_path, &#39;metadata&#39;: metadata, &#39;timestamp&#39;: time.time() } def load_model_version(self, version): &#34;&#34;&#34;åŠ è½½æ¨¡åž‹ç‰ˆæœ¬&#34;&#34;&#34; if version not in self.versions: raise ValueError(f&#34;ç‰ˆæœ¬ {version} ä¸å­˜åœ¨&#34;) version_path = self.versions[version][&#39;path&#39;] return tf.keras.models.load_model(version_path) def list_versions(self): &#34;&#34;&#34;åˆ—å‡ºç‰ˆæœ¬&#34;&#34;&#34; return list(self.versions.keys()) def rollback(self, version): &#34;&#34;&#34;å›žæ»šåˆ°æŒ‡å®šç‰ˆæœ¬&#34;&#34;&#34; model = self.load_model_version(version) self.save_model_version(model, &#39;current&#39;, {&#39;rollback_from&#39;: version}) return model # ä½¿ç”¨ç‰ˆæœ¬ç®¡ç†å™¨ version_manager = ModelVersionManager(&#39;./models&#39;) # ä¿å­˜ä¸åŒç‰ˆæœ¬ for i, model in enumerate([model_v1, model_v2, model_v3]): version_manager.save_model_version( model, version=f&#34;v{i&#43;1}&#34;, metadata={&#39;description&#39;: f&#39;æ¨¡åž‹ç‰ˆæœ¬{i&#43;1}&#39;, &#39;accuracy&#39;: 0.95 &#43; i*0.01} ) æœ€è¿‘æ›´æ–°: {{ .Lastmod.Format â€œ2006-01-02â€ }}">

    <meta property="og:url" content="http://localhost:1313/wiki/deep_learning/tensorflow/advanced_2/">
  <meta property="og:site_name" content="Yaku Makki">
  <meta property="og:title" content="TensorFlowé«˜çº§åº”ç”¨">
  <meta property="og:description" content="TensorFlowé«˜çº§åº”ç”¨ æœ¬ç« ä»‹ç»TensorFlowåœ¨å®žé™…é¡¹ç›®ä¸­çš„é«˜çº§åº”ç”¨ï¼ŒåŒ…æ‹¬è®¡ç®—æœºè§†è§‰ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€å¼ºåŒ–å­¦ä¹ ã€æ¨¡åž‹éƒ¨ç½²ç­‰é¢†åŸŸçš„å®Œæ•´è§£å†³æ–¹æ¡ˆå’Œæœ€ä½³å®žè·µã€‚
ðŸŽ¨ è®¡ç®—æœºè§†è§‰åº”ç”¨ ç›®æ ‡æ£€æµ‹ - YOLOå®žçŽ° import tensorflow as tf import numpy as np import cv2 def create_yolo_model(num_classes, input_shape=(416, 416, 3)): &#34;&#34;&#34;åˆ›å»ºYOLOæ¨¡åž‹&#34;&#34;&#34; inputs = tf.keras.Input(shape=input_shape) # ç‰¹å¾æå–ç½‘ç»œ x = tf.keras.layers.Conv2D(32, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(inputs) x = tf.keras.layers.BatchNormalization()(x) x = tf.keras.layers.MaxPooling2D(pool_size=2)(x) x = tf.keras.layers.Conv2D(64, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) x = tf.keras.layers.BatchNormalization()(x) x = tf.keras.layers.MaxPooling2D(pool_size=2)(x) x = tf.keras.layers.Conv2D(128, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) x = tf.keras.layers.BatchNormalization()(x) x = tf.keras.layers.MaxPooling2D(pool_size=2)(x) # æ£€æµ‹å¤´ x = tf.keras.layers.Conv2D(256, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) x = tf.keras.layers.Conv2D(512, 3, strides=1, padding=&#39;same&#39;, activation=&#39;relu&#39;)(x) # è¾“å‡ºå±‚ï¼šè¾¹ç•Œæ¡†ã€ç½®ä¿¡åº¦å’Œç±»åˆ«é¢„æµ‹ output = tf.keras.layers.Conv2D( num_classes &#43; 5, 1, strides=1, padding=&#39;same&#39;, activation=&#39;linear&#39; )(x) return tf.keras.Model(inputs=inputs, outputs=output) # YOLOæŸå¤±å‡½æ•° class YOLOLoss(tf.keras.losses.Loss): def __init__(self, num_classes, grid_size=13, **kwargs): super(YOLOLoss, self).__init__(**kwargs) self.num_classes = num_classes self.grid_size = grid_size def call(self, y_true, y_pred): # å®žçŽ°YOLOæŸå¤±å‡½æ•° # åŒ…æ‹¬è¾¹ç•Œæ¡†å›žå½’æŸå¤±ã€ç½®ä¿¡åº¦æŸå¤±å’Œåˆ†ç±»æŸå¤± return total_loss # åˆ›å»ºå’Œè®­ç»ƒYOLOæ¨¡åž‹ model = create_yolo_model(num_classes=20) model.compile( optimizer=tf.keras.optimizers.Adam(learning_rate=0.001), loss=YOLOLoss(num_classes=20), metrics=[&#39;accuracy&#39;] ) å›¾åƒåˆ†å‰² - U-Netå®žçŽ° def create_unet_model(input_shape=(256, 256, 3), num_classes=1): &#34;&#34;&#34;åˆ›å»ºU-Netæ¨¡åž‹&#34;&#34;&#34; inputs = tf.keras.Input(shape=input_shape) # ç¼–ç å™¨ c1 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(inputs) c1 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c1) p1 = tf.keras.layers.MaxPooling2D(pool_size=2)(c1) c2 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(p1) c2 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c2) p2 = tf.keras.layers.MaxPooling2D(pool_size=2)(c2) c3 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(p2) c3 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c3) p3 = tf.keras.layers.MaxPooling2D(pool_size=2)(c3) # ç“¶é¢ˆå±‚ c4 = tf.keras.layers.Conv2D(512, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(p3) c4 = tf.keras.layers.Conv2D(512, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c4) # è§£ç å™¨ u5 = tf.keras.layers.Conv2DTranspose(256, 2, strides=2, padding=&#39;same&#39;)(c4) u5 = tf.keras.layers.concatenate([u5, c3]) c5 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(u5) c5 = tf.keras.layers.Conv2D(256, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c5) u6 = tf.keras.layers.Conv2DTranspose(128, 2, strides=2, padding=&#39;same&#39;)(c5) u6 = tf.keras.layers.concatenate([u6, c2]) c6 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(u6) c6 = tf.keras.layers.Conv2D(128, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c6) u7 = tf.keras.layers.Conv2DTranspose(64, 2, strides=2, padding=&#39;same&#39;)(c6) u7 = tf.keras.layers.concatenate([u7, c1]) c7 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(u7) c7 = tf.keras.layers.Conv2D(64, 3, padding=&#39;same&#39;, activation=&#39;relu&#39;)(c7) # è¾“å‡ºå±‚ outputs = tf.keras.layers.Conv2D(num_classes, 1, activation=&#39;sigmoid&#39;)(c7) return tf.keras.Model(inputs=inputs, outputs=outputs) # DiceæŸå¤±å‡½æ•° def dice_loss(y_true, y_pred): smooth = 1e-15 intersection = tf.reduce_sum(y_true * y_pred) union = tf.reduce_sum(y_true) &#43; tf.reduce_sum(y_pred) dice = (2.0 * intersection &#43; smooth) / (union &#43; smooth) return 1.0 - dice # åˆ›å»ºå’Œè®­ç»ƒU-Net model = create_unet_model() model.compile( optimizer=tf.keras.optimizers.Adam(learning_rate=0.001), loss=dice_loss, metrics=[tf.keras.metrics.MeanIoU(num_classes=2)] ) ðŸ“ è‡ªç„¶è¯­è¨€å¤„ç†åº”ç”¨ Transformeræ¨¡åž‹å®žçŽ° class TransformerModel(tf.keras.Model): def __init__(self, vocab_size, d_model, num_heads, num_layers, d_ff, max_len): super(TransformerModel, self).__init__() self.embedding = tf.keras.layers.Embedding(vocab_size, d_model) self.pos_encoding = self.positional_encoding(max_len, d_model) self.encoder_layers = [ self.encoder_layer(d_model, num_heads, d_ff) for _ in range(num_layers) ] self.decoder_layers = [ self.decoder_layer(d_model, num_heads, d_ff) for _ in range(num_layers) ] self.final_layer = tf.keras.layers.Dense(vocab_size) def positional_encoding(self, max_len, d_model): pos = tf.range(max_len, dtype=tf.float32)[:, tf.newaxis] i = tf.range(d_model, dtype=tf.float32)[tf.newaxis, :] angle_rates = 1 / tf.pow(10000, (2 * (i // 2)) / tf.cast(d_model, tf.float32)) angle_rads = pos * angle_rates angle_rads = tf.where(i % 2 == 0, tf.sin(angle_rads), tf.cos(angle_rads)) return angle_rads[tf.newaxis, ...] def encoder_layer(self, d_model, num_heads, d_ff): inputs = tf.keras.Input(shape=(None, d_model)) # å¤šå¤´æ³¨æ„åŠ› attn_output = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(inputs, inputs) attn_output = tf.keras.layers.Dropout(0.1)(attn_output) out1 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(inputs &#43; attn_output) # å‰é¦ˆç½‘ç»œ ffn_output = tf.keras.layers.Dense(d_ff, activation=&#39;relu&#39;)(out1) ffn_output = tf.keras.layers.Dense(d_model)(ffn_output) ffn_output = tf.keras.layers.Dropout(0.1)(ffn_output) out2 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out1 &#43; ffn_output) return tf.keras.Model(inputs=inputs, outputs=out2) def decoder_layer(self, d_model, num_heads, d_ff): inputs = tf.keras.Input(shape=(None, d_model)) enc_output = tf.keras.Input(shape=(None, d_model)) # æŽ©ç å¤šå¤´æ³¨æ„åŠ› attn1 = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(inputs, inputs) attn1 = tf.keras.layers.Dropout(0.1)(attn1) out1 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(inputs &#43; attn1) # ç¼–ç å™¨-è§£ç å™¨æ³¨æ„åŠ› attn2 = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(out1, enc_output) attn2 = tf.keras.layers.Dropout(0.1)(attn2) out2 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out1 &#43; attn2) # å‰é¦ˆç½‘ç»œ ffn_output = tf.keras.layers.Dense(d_ff, activation=&#39;relu&#39;)(out2) ffn_output = tf.keras.layers.Dense(d_model)(ffn_output) ffn_output = tf.keras.layers.Dropout(0.1)(ffn_output) out3 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out2 &#43; ffn_output) return tf.keras.Model(inputs=[inputs, enc_output], outputs=out3) def call(self, inputs, targets=None, training=False): # è¯åµŒå…¥ &#43; ä½ç½®ç¼–ç  x = self.embedding(inputs) x *= tf.math.sqrt(tf.cast(tf.shape(x)[-1], tf.float32)) x &#43;= self.pos_encoding[:, :tf.shape(x)[1], :] # ç¼–ç å™¨ enc_output = x for layer in self.encoder_layers: enc_output = layer(enc_output) # è§£ç å™¨ if targets is not None: y = self.embedding(targets) y *= tf.math.sqrt(tf.cast(tf.shape(y)[-1], tf.float32)) y &#43;= self.pos_encoding[:, :tf.shape(y)[1], :] for layer in self.decoder_layers: y = layer([y, enc_output]) outputs = self.final_layer(y) else: outputs = None return outputs, enc_output # åˆ›å»ºTransformeræ¨¡åž‹ model = TransformerModel( vocab_size=10000, d_model=512, num_heads=8, num_layers=6, d_ff=2048, max_len=100 ) BERTé¢„è®­ç»ƒæ¨¡åž‹ class BERTModel(tf.keras.Model): def __init__(self, vocab_size, d_model, num_heads, num_layers, d_ff, max_len): super(BERTModel, self).__init__() self.embedding = tf.keras.layers.Embedding(vocab_size, d_model) self.pos_encoding = self.positional_encoding(max_len, d_model) self.segment_embedding = tf.keras.layers.Embedding(2, d_model) self.transformer_layers = [ self.transformer_layer(d_model, num_heads, d_ff) for _ in range(num_layers) ] self.mlm_head = tf.keras.layers.Dense(vocab_size, activation=&#39;softmax&#39;) self.nsp_head = tf.keras.layers.Dense(2, activation=&#39;softmax&#39;) def transformer_layer(self, d_model, num_heads, d_ff): inputs = tf.keras.Input(shape=(None, d_model)) # å¤šå¤´æ³¨æ„åŠ› attn_output = tf.keras.layers.MultiHeadAttention(num_heads, d_model)(inputs, inputs) attn_output = tf.keras.layers.Dropout(0.1)(attn_output) out1 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(inputs &#43; attn_output) # å‰é¦ˆç½‘ç»œ ffn_output = tf.keras.layers.Dense(d_ff, activation=&#39;relu&#39;)(out1) ffn_output = tf.keras.layers.Dense(d_model)(ffn_output) ffn_output = tf.keras.layers.Dropout(0.1)(ffn_output) out2 = tf.keras.layers.LayerNormalization(epsilon=1e-6)(out1 &#43; ffn_output) return tf.keras.Model(inputs=inputs, outputs=out2) def call(self, inputs, segment_ids=None, masked_positions=None): # è¯åµŒå…¥ &#43; ä½ç½®ç¼–ç  &#43; æ®µç¼–ç  x = self.embedding(inputs) x &#43;= self.pos_encoding[:, :tf.shape(x)[1], :] if segment_ids is not None: x &#43;= self.segment_embedding(segment_ids) # Transformerå±‚ for layer in self.transformer_layers: x = layer(x) # æŽ©ç è¯­è¨€æ¨¡åž‹é¢„æµ‹ if masked_positions is not None: masked_outputs = tf.gather(x, masked_positions, axis=1, batch_dims=1) mlm_logits = self.mlm_head(masked_outputs) else: mlm_logits = None # ä¸‹ä¸€å¥é¢„æµ‹ cls_token = x[:, 0, :] # [CLS] token nsp_logits = self.nsp_head(cls_token) return mlm_logits, nsp_logits # åˆ›å»ºBERTæ¨¡åž‹ bert_model = BERTModel( vocab_size=30000, d_model=768, num_heads=12, num_layers=12, d_ff=3072, max_len=512 ) ðŸŽ® å¼ºåŒ–å­¦ä¹ åº”ç”¨ DQNå®žçŽ° import tensorflow as tf import numpy as np import random from collections import deque class DQNAgent: def __init__(self, state_size, action_size): self.state_size = state_size self.action_size = action_size self.memory = deque(maxlen=2000) self.gamma = 0.95 # æŠ˜æ‰£å› å­ self.epsilon = 1.0 # æŽ¢ç´¢çŽ‡ self.epsilon_min = 0.01 self.epsilon_decay = 0.995 self.learning_rate = 0.001 self.model = self._build_model() self.target_model = self._build_model() self.update_target_model() def _build_model(self): &#34;&#34;&#34;æž„å»ºDQNç½‘ç»œ&#34;&#34;&#34; model = tf.keras.Sequential([ tf.keras.layers.Dense(24, input_dim=self.state_size, activation=&#39;relu&#39;), tf.keras.layers.Dense(24, activation=&#39;relu&#39;), tf.keras.layers.Dense(self.action_size, activation=&#39;linear&#39;) ]) model.compile( optimizer=tf.keras.optimizers.Adam(learning_rate=self.learning_rate), loss=&#39;mse&#39; ) return model def update_target_model(self): &#34;&#34;&#34;æ›´æ–°ç›®æ ‡ç½‘ç»œ&#34;&#34;&#34; self.target_model.set_weights(self.model.get_weights()) def remember(self, state, action, reward, next_state, done): &#34;&#34;&#34;å­˜å‚¨ç»éªŒ&#34;&#34;&#34; self.memory.append((state, action, reward, next_state, done)) def act(self, state): &#34;&#34;&#34;é€‰æ‹©åŠ¨ä½œ&#34;&#34;&#34; if np.random.rand() &lt;= self.epsilon: return random.randrange(self.action_size) # éšæœºæŽ¢ç´¢ act_values = self.model.predict(state, verbose=0) return np.argmax(act_values[0]) # åˆ©ç”¨ def replay(self, batch_size): &#34;&#34;&#34;ç»éªŒå›žæ”¾&#34;&#34;&#34; minibatch = random.sample(self.memory, batch_size) for state, action, reward, next_state, done in minibatch: target = self.model.predict(state, verbose=0) if done: target[0][action] = reward else: t = self.target_model.predict(next_state, verbose=0) target[0][action] = reward &#43; self.gamma * np.amax(t[0]) self.model.fit(state, target, epochs=1, verbose=0) if self.epsilon &gt; self.epsilon_min: self.epsilon *= self.epsilon_decay # ä½¿ç”¨DQNä»£ç† env = gym.make(&#39;CartPole-v1&#39;) state_size = env.observation_space.shape[0] action_size = env.action_space.n agent = DQNAgent(state_size, action_size) # è®­ç»ƒDQN episodes = 1000 batch_size = 32 for e in range(episodes): state = env.reset() state = np.reshape(state, [1, state_size]) for time in range(500): action = agent.act(state) next_state, reward, done, _ = env.step(action) next_state = np.reshape(next_state, [1, state_size]) agent.remember(state, action, reward, next_state, done) state = next_state if done: agent.update_target_model() print(f&#34;Episode: {e}/{episodes}, Score: {time}&#34;) break if len(agent.memory) &gt; batch_size: agent.replay(batch_size) PPOå®žçŽ° class PPOAgent: def __init__(self, state_size, action_size, clip_ratio=0.2): self.state_size = state_size self.action_size = action_size self.clip_ratio = clip_ratio # Actorç½‘ç»œ self.actor = self._build_actor() # Criticç½‘ç»œ self.critic = self._build_critic() self.actor_optimizer = tf.keras.optimizers.Adam(learning_rate=0.0003) self.critic_optimizer = tf.keras.optimizers.Adam(learning_rate=0.001) def _build_actor(self): &#34;&#34;&#34;æž„å»ºç­–ç•¥ç½‘ç»œ&#34;&#34;&#34; inputs = tf.keras.Input(shape=(self.state_size,)) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(inputs) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(x) outputs = tf.keras.layers.Dense(self.action_size, activation=&#39;softmax&#39;)(x) return tf.keras.Model(inputs=inputs, outputs=outputs) def _build_critic(self): &#34;&#34;&#34;æž„å»ºä»·å€¼ç½‘ç»œ&#34;&#34;&#34; inputs = tf.keras.Input(shape=(self.state_size,)) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(inputs) x = tf.keras.layers.Dense(64, activation=&#39;relu&#39;)(x) outputs = tf.keras.layers.Dense(1)(x) return tf.keras.Model(inputs=inputs, outputs=outputs) def get_action(self, state): &#34;&#34;&#34;èŽ·å–åŠ¨ä½œ&#34;&#34;&#34; state = np.reshape(state, [1, self.state_size]) probs = self.actor.predict(state, verbose=0)[0] action = np.random.choice(self.action_size, p=probs) return action, probs[action] def compute_advantages(self, rewards, values, next_values, dones): &#34;&#34;&#34;è®¡ç®—ä¼˜åŠ¿å‡½æ•°&#34;&#34;&#34; advantages = np.zeros_like(rewards) last_gae_lam = 0 for t in reversed(range(len(rewards))): if t == len(rewards) - 1: next_non_terminal = 1.0 - dones[t] next_values = next_values[t] else: next_non_terminal = 1.0 - dones[t] next_values = values[t &#43; 1] delta = rewards[t] &#43; 0.99 * next_values * next_non_terminal - values[t] advantages[t] = last_gae_lam = delta &#43; 0.99 * 0.95 * next_non_terminal * last_gae_lam return advantages def train(self, states, actions, old_probs, advantages, returns): &#34;&#34;&#34;PPOè®­ç»ƒ&#34;&#34;&#34; with tf.GradientTape() as tape: probs = self.actor(states) values = self.critic(states) # è®¡ç®—ç­–ç•¥æŸå¤± new_probs = tf.gather(probs, actions, axis=1, batch_dims=1) ratio = new_probs / old_probs clipped_ratio = tf.clip_by_value(ratio, 1 - self.clip_ratio, 1 &#43; self.clip_ratio) policy_loss = -tf.reduce_mean(tf.minimum(ratio * advantages, clipped_ratio * advantages)) # è®¡ç®—ä»·å€¼æŸå¤± value_loss = tf.reduce_mean(tf.square(returns - values)) # æ€»æŸå¤± loss = policy_loss &#43; 0.5 * value_loss # æ›´æ–°Actor actor_grads = tape.gradient(policy_loss, self.actor.trainable_variables) self.actor_optimizer.apply_gradients(zip(actor_grads, self.actor.trainable_variables)) # æ›´æ–°Critic critic_grads = tape.gradient(value_loss, self.critic.trainable_variables) self.critic_optimizer.apply_gradients(zip(critic_grads, self.critic.trainable_variables)) return loss ðŸš€ æ¨¡åž‹éƒ¨ç½² TensorFlow Serving # ä¿å­˜æ¨¡åž‹ç”¨äºŽServing import tensorflow as tf # åˆ›å»ºæ¨¡åž‹ model = tf.keras.Sequential([ tf.keras.layers.Dense(64, activation=&#39;relu&#39;, input_shape=(10,)), tf.keras.layers.Dense(1, activation=&#39;sigmoid&#39;) ]) # è®­ç»ƒæ¨¡åž‹ï¼ˆç¤ºä¾‹ï¼‰ # model.fit(...) # ä¿å­˜æ¨¡åž‹ model.save(&#39;model/1&#39;) # TensorFlow Servingæ ¼å¼ # å¯åŠ¨TensorFlow Serving &#34;&#34;&#34; tensorflow_model_server \ --rest_api_port=8501 \ --model_name=my_model \ --model_base_path=/path/to/model &#34;&#34;&#34; # ä½¿ç”¨REST APIè¿›è¡Œé¢„æµ‹ import requests import json data = json.dumps({ &#34;signature_name&#34;: &#34;serving_default&#34;, &#34;inputs&#34;: { &#34;dense_input&#34;: [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]] } }) headers = {&#34;content-type&#34;: &#34;application/json&#34;} response = requests.post(&#39;http://localhost:8501/v1/models/my_model:predict&#39;, data=data, headers=headers) print(response.json()) TensorFlow Liteè½¬æ¢å’Œéƒ¨ç½² # è½¬æ¢ä¸ºTensorFlow Lite def convert_to_tflite(model, quantization=&#39;float32&#39;): &#34;&#34;&#34;è½¬æ¢ä¸ºTensorFlow Liteæ ¼å¼&#34;&#34;&#34; # åˆ›å»ºè½¬æ¢å™¨ converter = tf.lite.TFLiteConverter.from_keras_model(model) if quantization == &#39;float16&#39;: converter.optimizations = [tf.lite.Optimize.DEFAULT] converter.target_spec.supported_types = [tf.float16] elif quantization == &#39;int8&#39;: converter.optimizations = [tf.lite.Optimize.DEFAULT] # æä¾›ä»£è¡¨æ€§æ•°æ®é›†ç”¨äºŽé‡åŒ– def representative_data_gen(): for input_value in tf.data.Dataset.from_tensor_slices(x_train).batch(1).take(100): yield [input_value] converter.representative_dataset = representative_data_gen converter.target_spec.supported_ops = [tf.lite.OpsSet.TFLITE_BUILTINS_INT8] converter.inference_input_type = tf.int8 converter.inference_output_type = tf.int8 # è½¬æ¢æ¨¡åž‹ tflite_model = converter.convert() # ä¿å­˜æ¨¡åž‹ with open(f&#39;model_{quantization}.tflite&#39;, &#39;wb&#39;) as f: f.write(tflite_model) return tflite_model # è½¬æ¢ä¸åŒç²¾åº¦ç‰ˆæœ¬ model = create_model() # å‡è®¾çš„æ¨¡åž‹åˆ›å»ºå‡½æ•° # è½¬æ¢ä¸ºä¸åŒç²¾åº¦ convert_to_tflite(model, &#39;float32&#39;) convert_to_tflite(model, &#39;float16&#39;) convert_to_tflite(model, &#39;int8&#39;) # è¯„ä¼°æ¨¡åž‹å¤§å°å’Œæ€§èƒ½ import os for precision in [&#39;float32&#39;, &#39;float16&#39;, &#39;int8&#39;]: model_path = f&#39;model_{precision}.tflite&#39; if os.path.exists(model_path): size = os.path.getsize(model_path) / 1024 / 1024 # MB print(f&#34;{precision}æ¨¡åž‹å¤§å°: {size:.2f} MB&#34;) TensorFlow.jsè½¬æ¢ # è½¬æ¢ä¸ºTensorFlow.jsæ ¼å¼ import tensorflowjs as tfjs # ä¿å­˜ä¸ºTensorFlow.jsæ ¼å¼ tfjs.converters.save_keras_model(model, &#39;tfjs_model/&#39;) # æˆ–è€…è½¬æ¢ä¸ºåˆ†å±‚æ ¼å¼ tfjs.converters.save_keras_model(model, &#39;tfjs_model/&#39;, quantization_dtype=tfjs.quantization_config.INT8) # HTMLä¸­ä½¿ç”¨æ¨¡åž‹ &#34;&#34;&#34; &lt;html&gt; &lt;head&gt; &lt;script src=&#34;https://cdn.jsdelivr.net/npm/@tensorflow/tfjs&#34;&gt;&lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;script&gt; async function loadModel() { // åŠ è½½æ¨¡åž‹ const model = await tf.loadLayersModel(&#39;tfjs_model/model.json&#39;); // å‡†å¤‡è¾“å…¥æ•°æ® const input = tf.tensor2d([[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]]); // è¿›è¡Œé¢„æµ‹ const prediction = model.predict(input); prediction.print(); } loadModel(); &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; &#34;&#34;&#34; ðŸ“Š ç”Ÿäº§çŽ¯å¢ƒæœ€ä½³å®žè·µ æ¨¡åž‹ç›‘æŽ§ class ModelMonitor: def __init__(self, model, metrics=[&#39;accuracy&#39;, &#39;latency&#39;, &#39;throughput&#39;]): self.model = model self.metrics = metrics self.predictions = [] self.true_labels = [] self.latencies = [] def predict_with_monitoring(self, inputs, true_labels=None): &#34;&#34;&#34;å¸¦ç›‘æŽ§çš„é¢„æµ‹&#34;&#34;&#34; import time start_time = time.time() # è¿›è¡Œé¢„æµ‹ predictions = self.model.predict(inputs) end_time = time.time() latency = end_time - start_time # è®°å½•æŒ‡æ ‡ self.latencies.append(latency) self.predictions.extend(predictions) if true_labels is not None: self.true_labels.extend(true_labels) return predictions def generate_report(self): &#34;&#34;&#34;ç”Ÿæˆç›‘æŽ§æŠ¥å‘Š&#34;&#34;&#34; report = {} if self.latencies: report[&#39;avg_latency&#39;] = np.mean(self.latencies) report[&#39;p95_latency&#39;] = np.percentile(self.latencies, 95) report[&#39;throughput&#39;] = len(self.latencies) / sum(self.latencies) if self.true_labels and self.predictions: predictions = np.array(self.predictions) true_labels = np.array(self.true_labels) if len(predictions.shape) &gt; 1: pred_classes = np.argmax(predictions, axis=1) true_classes = np.argmax(true_labels, axis=1) else: pred_classes = (predictions &gt; 0.5).astype(int) true_classes = true_labels report[&#39;accuracy&#39;] = np.mean(pred_classes == true_classes) return report # ä½¿ç”¨æ¨¡åž‹ç›‘æŽ§ monitor = ModelMonitor(model) # æ¨¡æ‹Ÿç”Ÿäº§çŽ¯å¢ƒé¢„æµ‹ for i in range(100): test_input = np.random.rand(1, 10) true_label = np.random.randint(0, 2, 1) prediction = monitor.predict_with_monitoring(test_input, true_label) # ç”ŸæˆæŠ¥å‘Š report = monitor.generate_report() print(&#34;æ¨¡åž‹ç›‘æŽ§æŠ¥å‘Š:&#34;, report) A/Bæµ‹è¯•æ¡†æž¶ class ABTestFramework: def __init__(self, model_a, model_b, traffic_split=0.5): self.model_a = model_a self.model_b = model_b self.traffic_split = traffic_split self.model_a_metrics = [] self.model_b_metrics = [] def predict(self, inputs, true_labels=None): &#34;&#34;&#34;A/Bæµ‹è¯•é¢„æµ‹&#34;&#34;&#34; results = [] for i, (input_data, true_label) in enumerate(zip(inputs, true_labels or [])): # éšæœºåˆ†é…æµé‡ if np.random.random() &lt; self.traffic_split: model = self.model_a model_name = &#39;A&#39; else: model = self.model_b model_name = &#39;B&#39; # è¿›è¡Œé¢„æµ‹ prediction = model.predict(np.expand_dims(input_data, 0))[0] results.append({ &#39;model&#39;: model_name, &#39;prediction&#39;: prediction, &#39;true_label&#39;: true_label }) return results def evaluate_models(self, results): &#34;&#34;&#34;è¯„ä¼°æ¨¡åž‹æ€§èƒ½&#34;&#34;&#34; model_a_results = [r for r in results if r[&#39;model&#39;] == &#39;A&#39;] model_b_results = [r for r in results if r[&#39;model&#39;] == &#39;B&#39;] def calculate_metrics(results): if not results: return {} predictions = np.array([r[&#39;prediction&#39;] for r in results]) true_labels = np.array([r[&#39;true_label&#39;] for r in results]) pred_classes = np.argmax(predictions, axis=1) true_classes = np.argmax(true_labels, axis=1) accuracy = np.mean(pred_classes == true_classes) return {&#39;accuracy&#39;: accuracy, &#39;sample_size&#39;: len(results)} metrics_a = calculate_metrics(model_a_results) metrics_b = calculate_metrics(model_b_results) return {&#39;model_a&#39;: metrics_a, &#39;model_b&#39;: metrics_b} # ä½¿ç”¨A/Bæµ‹è¯•æ¡†æž¶ ab_test = ABTestFramework(model_v1, model_v2, traffic_split=0.5) # æ¨¡æ‹ŸA/Bæµ‹è¯• test_inputs = [np.random.rand(10) for _ in range(1000)] test_labels = [np.random.randint(0, 2, 10) for _ in range(1000)] results = ab_test.predict(test_inputs, test_labels) metrics = ab_test.evaluate_models(results) print(&#34;A/Bæµ‹è¯•ç»“æžœ:&#34;, metrics) ðŸ“š å­¦ä¹ èµ„æº å®˜æ–¹æ–‡æ¡£ TensorFlow Servingæ–‡æ¡£ TensorFlow Liteæ–‡æ¡£ TensorFlow.jsæ–‡æ¡£ å´æ©è¾¾è¯¾ç¨‹ æ·±åº¦å­¦ä¹ è¯¾ç¨‹ä¸­å…³äºŽå®žé™…åº”ç”¨çš„éƒ¨åˆ† ç»å…¸é¡¹ç›® TensorFlow Models - å®˜æ–¹æ¨¡åž‹åº“ TensorFlow Hub - é¢„è®­ç»ƒæ¨¡åž‹ä»“åº“ Kaggleç«žèµ› - å®žè·µé¡¹ç›® ðŸ”§ éƒ¨ç½²æœ€ä½³å®žè·µ å®¹å™¨åŒ–éƒ¨ç½² # Dockerfile FROM tensorflow/serving:latest COPY model/ /models/my_model ENV MODEL_NAME=my_model # å¯åŠ¨å‘½ä»¤ CMD [&#34;tensorflow_model_server&#34;, &#34;--rest_api_port=8501&#34;, &#34;--model_name=my_model&#34;, &#34;--model_base_path=/models/my_model&#34;] æ¨¡åž‹ç‰ˆæœ¬ç®¡ç† # æ¨¡åž‹ç‰ˆæœ¬ç®¡ç† import tensorflow as tf class ModelVersionManager: def __init__(self, model_base_path): self.model_base_path = model_base_path self.versions = {} def save_model_version(self, model, version, metadata=None): &#34;&#34;&#34;ä¿å­˜æ¨¡åž‹ç‰ˆæœ¬&#34;&#34;&#34; version_path = f&#34;{self.model_base_path}/{version}&#34; # ä¿å­˜æ¨¡åž‹ model.save(version_path) # ä¿å­˜å…ƒæ•°æ® if metadata: with open(f&#34;{version_path}/metadata.json&#34;, &#39;w&#39;) as f: json.dump(metadata, f) self.versions[version] = { &#39;path&#39;: version_path, &#39;metadata&#39;: metadata, &#39;timestamp&#39;: time.time() } def load_model_version(self, version): &#34;&#34;&#34;åŠ è½½æ¨¡åž‹ç‰ˆæœ¬&#34;&#34;&#34; if version not in self.versions: raise ValueError(f&#34;ç‰ˆæœ¬ {version} ä¸å­˜åœ¨&#34;) version_path = self.versions[version][&#39;path&#39;] return tf.keras.models.load_model(version_path) def list_versions(self): &#34;&#34;&#34;åˆ—å‡ºç‰ˆæœ¬&#34;&#34;&#34; return list(self.versions.keys()) def rollback(self, version): &#34;&#34;&#34;å›žæ»šåˆ°æŒ‡å®šç‰ˆæœ¬&#34;&#34;&#34; model = self.load_model_version(version) self.save_model_version(model, &#39;current&#39;, {&#39;rollback_from&#39;: version}) return model # ä½¿ç”¨ç‰ˆæœ¬ç®¡ç†å™¨ version_manager = ModelVersionManager(&#39;./models&#39;) # ä¿å­˜ä¸åŒç‰ˆæœ¬ for i, model in enumerate([model_v1, model_v2, model_v3]): version_manager.save_model_version( model, version=f&#34;v{i&#43;1}&#34;, metadata={&#39;description&#39;: f&#39;æ¨¡åž‹ç‰ˆæœ¬{i&#43;1}&#39;, &#39;accuracy&#39;: 0.95 &#43; i*0.01} ) æœ€è¿‘æ›´æ–°: {{ .Lastmod.Format â€œ2006-01-02â€ }}">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="wiki">
    <meta property="article:published_time" content="2025-10-24T21:58:51+08:00">
    <meta property="article:modified_time" content="2025-10-24T21:58:51+08:00">


  </head>
  <body class="synthwave-bg">
    <header class="app-header glass-morphism neon-border">
      <a href="/"><img class="app-header-avatar" src="/assets/avatar/avatar.jpg" alt="Yaku Makki" /></a>
      <span class="app-header-title gradient-text">Yaku Makki</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">é¦–é¡µ</a>
             | 
          
          <a class="app-header-menu-item" href="/post/">åšå®¢</a>
             | 
          
          <a class="app-header-menu-item" href="/wiki/">ç»´åŸº</a>
             | 
          
          <a class="app-header-menu-item" href="/tags/">æ ‡ç­¾</a>
             | 
          
          <a class="app-header-menu-item" href="/about/">å…³äºŽ</a>
      </nav>
      <p>ä¸ªäººå°å·¢</p>
      <div class="app-header-social">
        
          <a href="https://github.com/makkichan947" target="_blank" rel="noreferrer noopener me" class="pulse-glow">
            <svg class="icon icon-brand-github" viewBox="0 0 24 24" fill="currentColor"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
          </a>
        
          <a href="mailto:yakumakki947@hotmail.com" target="_blank" rel="noreferrer noopener me" class="pulse-glow">
            <svg class="icon icon-mail" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>mail</title><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
          </a>
        
          <a href="https://x.com/Makki_Yaku947" target="_blank" rel="noreferrer noopener me" class="pulse-glow">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
          </a>
        
          <a href="https://www.twitch.tv/u/makkichan947" target="_blank" rel="noreferrer noopener me" class="pulse-glow">
            <svg class="icon icon-brand-twitch" viewBox="0 0 24 24" fill="currentColor"><title>Twitch</title><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/></svg>
          </a>
        
      </div>
    </header>
    <main class="app-container glass-morphism glow-effect">
      <div class="floating-particles">
        <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="left: 20%; animation-delay: 1s;"></div>
        <div class="particle" style="left: 30%; animation-delay: 2s;"></div>
        <div class="particle" style="left: 40%; animation-delay: 3s;"></div>
        <div class="particle" style="left: 50%; animation-delay: 4s;"></div>
        <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
        <div class="particle" style="left: 70%; animation-delay: 6s;"></div>
        <div class="particle" style="left: 80%; animation-delay: 7s;"></div>
        <div class="particle" style="left: 90%; animation-delay: 8s;"></div>
      </div>
      
  <article class="post enhanced-card glow-effect">
    <header class="post-header">
      <h1 class ="post-title gradient-text">TensorFlowé«˜çº§åº”ç”¨</h1>
      <div class="post-meta">
        <div>
          <svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Oct 24, 2025
        </div>
        <div>
          <svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          10 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <h1 id="tensorflowé«˜çº§åº”ç”¨">TensorFlowé«˜çº§åº”ç”¨</h1>
<p>æœ¬ç« ä»‹ç»TensorFlowåœ¨å®žé™…é¡¹ç›®ä¸­çš„é«˜çº§åº”ç”¨ï¼ŒåŒ…æ‹¬è®¡ç®—æœºè§†è§‰ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€å¼ºåŒ–å­¦ä¹ ã€æ¨¡åž‹éƒ¨ç½²ç­‰é¢†åŸŸçš„å®Œæ•´è§£å†³æ–¹æ¡ˆå’Œæœ€ä½³å®žè·µã€‚</p>
<h2 id="-è®¡ç®—æœºè§†è§‰åº”ç”¨">ðŸŽ¨ è®¡ç®—æœºè§†è§‰åº”ç”¨</h2>
<h3 id="ç›®æ ‡æ£€æµ‹---yoloå®žçŽ°">ç›®æ ‡æ£€æµ‹ - YOLOå®žçŽ°</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_yolo_model</span>(num_classes, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">416</span>, <span style="color:#ae81ff">416</span>, <span style="color:#ae81ff">3</span>)):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;åˆ›å»ºYOLOæ¨¡åž‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    inputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>input_shape)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ç‰¹å¾æå–ç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">3</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(inputs)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>BatchNormalization()(x)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MaxPooling2D(pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">3</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(x)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>BatchNormalization()(x)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MaxPooling2D(pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">3</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(x)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>BatchNormalization()(x)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MaxPooling2D(pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># æ£€æµ‹å¤´</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">3</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(x)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">3</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># è¾“å‡ºå±‚ï¼šè¾¹ç•Œæ¡†ã€ç½®ä¿¡åº¦å’Œç±»åˆ«é¢„æµ‹</span>
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(
</span></span><span style="display:flex;"><span>        num_classes <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linear&#39;</span>
</span></span><span style="display:flex;"><span>    )(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>inputs, outputs<span style="color:#f92672">=</span>output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YOLOæŸå¤±å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YOLOLoss</span>(tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>losses<span style="color:#f92672">.</span>Loss):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, num_classes, grid_size<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        super(YOLOLoss, self)<span style="color:#f92672">.</span><span style="color:#a6e22e">__init__</span>(<span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_classes <span style="color:#f92672">=</span> num_classes
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>grid_size <span style="color:#f92672">=</span> grid_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call</span>(self, y_true, y_pred):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># å®žçŽ°YOLOæŸå¤±å‡½æ•°</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># åŒ…æ‹¬è¾¹ç•Œæ¡†å›žå½’æŸå¤±ã€ç½®ä¿¡åº¦æŸå¤±å’Œåˆ†ç±»æŸå¤±</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> total_loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºå’Œè®­ç»ƒYOLOæ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> create_yolo_model(num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>compile(
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adam(learning_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>),
</span></span><span style="display:flex;"><span>    loss<span style="color:#f92672">=</span>YOLOLoss(num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>),
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>]
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="å›¾åƒåˆ†å‰²---u-netå®žçŽ°">å›¾åƒåˆ†å‰² - U-Netå®žçŽ°</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_unet_model</span>(input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">3</span>), num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;åˆ›å»ºU-Netæ¨¡åž‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    inputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>input_shape)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ç¼–ç å™¨</span>
</span></span><span style="display:flex;"><span>    c1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(inputs)
</span></span><span style="display:flex;"><span>    c1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(c1)
</span></span><span style="display:flex;"><span>    p1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MaxPooling2D(pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)(c1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    c2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(p1)
</span></span><span style="display:flex;"><span>    c2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(c2)
</span></span><span style="display:flex;"><span>    p2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MaxPooling2D(pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)(c2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    c3 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(p2)
</span></span><span style="display:flex;"><span>    c3 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(c3)
</span></span><span style="display:flex;"><span>    p3 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MaxPooling2D(pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)(c3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ç“¶é¢ˆå±‚</span>
</span></span><span style="display:flex;"><span>    c4 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(p3)
</span></span><span style="display:flex;"><span>    c4 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(c4)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># è§£ç å™¨</span>
</span></span><span style="display:flex;"><span>    u5 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2DTranspose(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">2</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>)(c4)
</span></span><span style="display:flex;"><span>    u5 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>concatenate([u5, c3])
</span></span><span style="display:flex;"><span>    c5 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(u5)
</span></span><span style="display:flex;"><span>    c5 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(c5)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    u6 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2DTranspose(<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">2</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>)(c5)
</span></span><span style="display:flex;"><span>    u6 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>concatenate([u6, c2])
</span></span><span style="display:flex;"><span>    c6 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(u6)
</span></span><span style="display:flex;"><span>    c6 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(c6)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    u7 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2DTranspose(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span>, strides<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>)(c6)
</span></span><span style="display:flex;"><span>    u7 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>concatenate([u7, c1])
</span></span><span style="display:flex;"><span>    c7 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(u7)
</span></span><span style="display:flex;"><span>    c7 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(c7)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># è¾“å‡ºå±‚</span>
</span></span><span style="display:flex;"><span>    outputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(num_classes, <span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sigmoid&#39;</span>)(c7)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>inputs, outputs<span style="color:#f92672">=</span>outputs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DiceæŸå¤±å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dice_loss</span>(y_true, y_pred):
</span></span><span style="display:flex;"><span>    smooth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-15</span>
</span></span><span style="display:flex;"><span>    intersection <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_sum(y_true <span style="color:#f92672">*</span> y_pred)
</span></span><span style="display:flex;"><span>    union <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_sum(y_true) <span style="color:#f92672">+</span> tf<span style="color:#f92672">.</span>reduce_sum(y_pred)
</span></span><span style="display:flex;"><span>    dice <span style="color:#f92672">=</span> (<span style="color:#ae81ff">2.0</span> <span style="color:#f92672">*</span> intersection <span style="color:#f92672">+</span> smooth) <span style="color:#f92672">/</span> (union <span style="color:#f92672">+</span> smooth)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> dice
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºå’Œè®­ç»ƒU-Net</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> create_unet_model()
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>compile(
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adam(learning_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>),
</span></span><span style="display:flex;"><span>    loss<span style="color:#f92672">=</span>dice_loss,
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">=</span>[tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>metrics<span style="color:#f92672">.</span>MeanIoU(num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)]
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="-è‡ªç„¶è¯­è¨€å¤„ç†åº”ç”¨">ðŸ“ è‡ªç„¶è¯­è¨€å¤„ç†åº”ç”¨</h2>
<h3 id="transformeræ¨¡åž‹å®žçŽ°">Transformeræ¨¡åž‹å®žçŽ°</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransformerModel</span>(tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, vocab_size, d_model, num_heads, num_layers, d_ff, max_len):
</span></span><span style="display:flex;"><span>        super(TransformerModel, self)<span style="color:#f92672">.</span><span style="color:#a6e22e">__init__</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>embedding <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Embedding(vocab_size, d_model)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pos_encoding <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>positional_encoding(max_len, d_model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>encoder_layers <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>encoder_layer(d_model, num_heads, d_ff) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(num_layers)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>decoder_layers <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>decoder_layer(d_model, num_heads, d_ff) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(num_layers)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>final_layer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(vocab_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">positional_encoding</span>(self, max_len, d_model):
</span></span><span style="display:flex;"><span>        pos <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>range(max_len, dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32)[:, tf<span style="color:#f92672">.</span>newaxis]
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>range(d_model, dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32)[tf<span style="color:#f92672">.</span>newaxis, :]
</span></span><span style="display:flex;"><span>        angle_rates <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> tf<span style="color:#f92672">.</span>pow(<span style="color:#ae81ff">10000</span>, (<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (i <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>)) <span style="color:#f92672">/</span> tf<span style="color:#f92672">.</span>cast(d_model, tf<span style="color:#f92672">.</span>float32))
</span></span><span style="display:flex;"><span>        angle_rads <span style="color:#f92672">=</span> pos <span style="color:#f92672">*</span> angle_rates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        angle_rads <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>where(i <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>, tf<span style="color:#f92672">.</span>sin(angle_rads), tf<span style="color:#f92672">.</span>cos(angle_rads))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> angle_rads[tf<span style="color:#f92672">.</span>newaxis, <span style="color:#f92672">...</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encoder_layer</span>(self, d_model, num_heads, d_ff):
</span></span><span style="display:flex;"><span>        inputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>, d_model))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># å¤šå¤´æ³¨æ„åŠ›</span>
</span></span><span style="display:flex;"><span>        attn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MultiHeadAttention(num_heads, d_model)(inputs, inputs)
</span></span><span style="display:flex;"><span>        attn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.1</span>)(attn_output)
</span></span><span style="display:flex;"><span>        out1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>LayerNormalization(epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)(inputs <span style="color:#f92672">+</span> attn_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># å‰é¦ˆç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(d_ff, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(out1)
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(d_model)(ffn_output)
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.1</span>)(ffn_output)
</span></span><span style="display:flex;"><span>        out2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>LayerNormalization(epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)(out1 <span style="color:#f92672">+</span> ffn_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>inputs, outputs<span style="color:#f92672">=</span>out2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decoder_layer</span>(self, d_model, num_heads, d_ff):
</span></span><span style="display:flex;"><span>        inputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>, d_model))
</span></span><span style="display:flex;"><span>        enc_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>, d_model))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># æŽ©ç å¤šå¤´æ³¨æ„åŠ›</span>
</span></span><span style="display:flex;"><span>        attn1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MultiHeadAttention(num_heads, d_model)(inputs, inputs)
</span></span><span style="display:flex;"><span>        attn1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.1</span>)(attn1)
</span></span><span style="display:flex;"><span>        out1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>LayerNormalization(epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)(inputs <span style="color:#f92672">+</span> attn1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ç¼–ç å™¨-è§£ç å™¨æ³¨æ„åŠ›</span>
</span></span><span style="display:flex;"><span>        attn2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MultiHeadAttention(num_heads, d_model)(out1, enc_output)
</span></span><span style="display:flex;"><span>        attn2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.1</span>)(attn2)
</span></span><span style="display:flex;"><span>        out2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>LayerNormalization(epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)(out1 <span style="color:#f92672">+</span> attn2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># å‰é¦ˆç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(d_ff, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(out2)
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(d_model)(ffn_output)
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.1</span>)(ffn_output)
</span></span><span style="display:flex;"><span>        out3 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>LayerNormalization(epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)(out2 <span style="color:#f92672">+</span> ffn_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>[inputs, enc_output], outputs<span style="color:#f92672">=</span>out3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call</span>(self, inputs, targets<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, training<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># è¯åµŒå…¥ + ä½ç½®ç¼–ç </span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>embedding(inputs)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">*=</span> tf<span style="color:#f92672">.</span>math<span style="color:#f92672">.</span>sqrt(tf<span style="color:#f92672">.</span>cast(tf<span style="color:#f92672">.</span>shape(x)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], tf<span style="color:#f92672">.</span>float32))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>pos_encoding[:, :tf<span style="color:#f92672">.</span>shape(x)[<span style="color:#ae81ff">1</span>], :]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ç¼–ç å™¨</span>
</span></span><span style="display:flex;"><span>        enc_output <span style="color:#f92672">=</span> x
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> layer <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>encoder_layers:
</span></span><span style="display:flex;"><span>            enc_output <span style="color:#f92672">=</span> layer(enc_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># è§£ç å™¨</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> targets <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            y <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>embedding(targets)
</span></span><span style="display:flex;"><span>            y <span style="color:#f92672">*=</span> tf<span style="color:#f92672">.</span>math<span style="color:#f92672">.</span>sqrt(tf<span style="color:#f92672">.</span>cast(tf<span style="color:#f92672">.</span>shape(y)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], tf<span style="color:#f92672">.</span>float32))
</span></span><span style="display:flex;"><span>            y <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>pos_encoding[:, :tf<span style="color:#f92672">.</span>shape(y)[<span style="color:#ae81ff">1</span>], :]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> layer <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>decoder_layers:
</span></span><span style="display:flex;"><span>                y <span style="color:#f92672">=</span> layer([y, enc_output])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>final_layer(y)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            outputs <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> outputs, enc_output
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºTransformeræ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> TransformerModel(
</span></span><span style="display:flex;"><span>    vocab_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10000</span>,
</span></span><span style="display:flex;"><span>    d_model<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>,
</span></span><span style="display:flex;"><span>    num_heads<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    num_layers<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>    d_ff<span style="color:#f92672">=</span><span style="color:#ae81ff">2048</span>,
</span></span><span style="display:flex;"><span>    max_len<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="berté¢„è®­ç»ƒæ¨¡åž‹">BERTé¢„è®­ç»ƒæ¨¡åž‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BERTModel</span>(tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, vocab_size, d_model, num_heads, num_layers, d_ff, max_len):
</span></span><span style="display:flex;"><span>        super(BERTModel, self)<span style="color:#f92672">.</span><span style="color:#a6e22e">__init__</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>embedding <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Embedding(vocab_size, d_model)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pos_encoding <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>positional_encoding(max_len, d_model)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>segment_embedding <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Embedding(<span style="color:#ae81ff">2</span>, d_model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>transformer_layers <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>transformer_layer(d_model, num_heads, d_ff) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(num_layers)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>mlm_head <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(vocab_size, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>nsp_head <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">2</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">transformer_layer</span>(self, d_model, num_heads, d_ff):
</span></span><span style="display:flex;"><span>        inputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>, d_model))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># å¤šå¤´æ³¨æ„åŠ›</span>
</span></span><span style="display:flex;"><span>        attn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MultiHeadAttention(num_heads, d_model)(inputs, inputs)
</span></span><span style="display:flex;"><span>        attn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.1</span>)(attn_output)
</span></span><span style="display:flex;"><span>        out1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>LayerNormalization(epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)(inputs <span style="color:#f92672">+</span> attn_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># å‰é¦ˆç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(d_ff, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(out1)
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(d_model)(ffn_output)
</span></span><span style="display:flex;"><span>        ffn_output <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.1</span>)(ffn_output)
</span></span><span style="display:flex;"><span>        out2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>LayerNormalization(epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)(out1 <span style="color:#f92672">+</span> ffn_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>inputs, outputs<span style="color:#f92672">=</span>out2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call</span>(self, inputs, segment_ids<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, masked_positions<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># è¯åµŒå…¥ + ä½ç½®ç¼–ç  + æ®µç¼–ç </span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>embedding(inputs)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>pos_encoding[:, :tf<span style="color:#f92672">.</span>shape(x)[<span style="color:#ae81ff">1</span>], :]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> segment_ids <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>segment_embedding(segment_ids)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Transformerå±‚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> layer <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>transformer_layers:
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> layer(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># æŽ©ç è¯­è¨€æ¨¡åž‹é¢„æµ‹</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> masked_positions <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            masked_outputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>gather(x, masked_positions, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, batch_dims<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            mlm_logits <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mlm_head(masked_outputs)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            mlm_logits <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ä¸‹ä¸€å¥é¢„æµ‹</span>
</span></span><span style="display:flex;"><span>        cls_token <span style="color:#f92672">=</span> x[:, <span style="color:#ae81ff">0</span>, :]  <span style="color:#75715e"># [CLS] token</span>
</span></span><span style="display:flex;"><span>        nsp_logits <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>nsp_head(cls_token)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> mlm_logits, nsp_logits
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºBERTæ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>bert_model <span style="color:#f92672">=</span> BERTModel(
</span></span><span style="display:flex;"><span>    vocab_size<span style="color:#f92672">=</span><span style="color:#ae81ff">30000</span>,
</span></span><span style="display:flex;"><span>    d_model<span style="color:#f92672">=</span><span style="color:#ae81ff">768</span>,
</span></span><span style="display:flex;"><span>    num_heads<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>,
</span></span><span style="display:flex;"><span>    num_layers<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>,
</span></span><span style="display:flex;"><span>    d_ff<span style="color:#f92672">=</span><span style="color:#ae81ff">3072</span>,
</span></span><span style="display:flex;"><span>    max_len<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="-å¼ºåŒ–å­¦ä¹ åº”ç”¨">ðŸŽ® å¼ºåŒ–å­¦ä¹ åº”ç”¨</h2>
<h3 id="dqnå®žçŽ°">DQNå®žçŽ°</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> deque
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DQNAgent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, state_size, action_size):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state_size <span style="color:#f92672">=</span> state_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>action_size <span style="color:#f92672">=</span> action_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory <span style="color:#f92672">=</span> deque(maxlen<span style="color:#f92672">=</span><span style="color:#ae81ff">2000</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>gamma <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.95</span>  <span style="color:#75715e"># æŠ˜æ‰£å› å­</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>epsilon <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>  <span style="color:#75715e"># æŽ¢ç´¢çŽ‡</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>epsilon_min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>epsilon_decay <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.995</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>learning_rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.001</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_build_model()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>target_model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_build_model()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>update_target_model()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_build_model</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;æž„å»ºDQNç½‘ç»œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Sequential([
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">24</span>, input_dim<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>state_size, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>),
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">24</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>),
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(self<span style="color:#f92672">.</span>action_size, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linear&#39;</span>)
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">.</span>compile(
</span></span><span style="display:flex;"><span>            optimizer<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adam(learning_rate<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>learning_rate),
</span></span><span style="display:flex;"><span>            loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mse&#39;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_target_model</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;æ›´æ–°ç›®æ ‡ç½‘ç»œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>target_model<span style="color:#f92672">.</span>set_weights(self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>get_weights())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remember</span>(self, state, action, reward, next_state, done):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;å­˜å‚¨ç»éªŒ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory<span style="color:#f92672">.</span>append((state, action, reward, next_state, done))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">act</span>(self, state):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;é€‰æ‹©åŠ¨ä½œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand() <span style="color:#f92672">&lt;=</span> self<span style="color:#f92672">.</span>epsilon:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> random<span style="color:#f92672">.</span>randrange(self<span style="color:#f92672">.</span>action_size)  <span style="color:#75715e"># éšæœºæŽ¢ç´¢</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        act_values <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>predict(state, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>argmax(act_values[<span style="color:#ae81ff">0</span>])  <span style="color:#75715e"># åˆ©ç”¨</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">replay</span>(self, batch_size):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;ç»éªŒå›žæ”¾&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        minibatch <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>sample(self<span style="color:#f92672">.</span>memory, batch_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> state, action, reward, next_state, done <span style="color:#f92672">in</span> minibatch:
</span></span><span style="display:flex;"><span>            target <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>predict(state, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> done:
</span></span><span style="display:flex;"><span>                target[<span style="color:#ae81ff">0</span>][action] <span style="color:#f92672">=</span> reward
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                t <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>target_model<span style="color:#f92672">.</span>predict(next_state, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                target[<span style="color:#ae81ff">0</span>][action] <span style="color:#f92672">=</span> reward <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>gamma <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>amax(t[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>fit(state, target, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>epsilon <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>epsilon_min:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>epsilon <span style="color:#f92672">*=</span> self<span style="color:#f92672">.</span>epsilon_decay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨DQNä»£ç†</span>
</span></span><span style="display:flex;"><span>env <span style="color:#f92672">=</span> gym<span style="color:#f92672">.</span>make(<span style="color:#e6db74">&#39;CartPole-v1&#39;</span>)
</span></span><span style="display:flex;"><span>state_size <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span>observation_space<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>action_size <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span>action_space<span style="color:#f92672">.</span>n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent <span style="color:#f92672">=</span> DQNAgent(state_size, action_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®­ç»ƒDQN</span>
</span></span><span style="display:flex;"><span>episodes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> range(episodes):
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span>reset()
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>reshape(state, [<span style="color:#ae81ff">1</span>, state_size])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> time <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">500</span>):
</span></span><span style="display:flex;"><span>        action <span style="color:#f92672">=</span> agent<span style="color:#f92672">.</span>act(state)
</span></span><span style="display:flex;"><span>        next_state, reward, done, _ <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span>step(action)
</span></span><span style="display:flex;"><span>        next_state <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>reshape(next_state, [<span style="color:#ae81ff">1</span>, state_size])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        agent<span style="color:#f92672">.</span>remember(state, action, reward, next_state, done)
</span></span><span style="display:flex;"><span>        state <span style="color:#f92672">=</span> next_state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> done:
</span></span><span style="display:flex;"><span>            agent<span style="color:#f92672">.</span>update_target_model()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Episode: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>episodes<span style="color:#e6db74">}</span><span style="color:#e6db74">, Score: </span><span style="color:#e6db74">{</span>time<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(agent<span style="color:#f92672">.</span>memory) <span style="color:#f92672">&gt;</span> batch_size:
</span></span><span style="display:flex;"><span>            agent<span style="color:#f92672">.</span>replay(batch_size)
</span></span></code></pre></div><h3 id="ppoå®žçŽ°">PPOå®žçŽ°</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PPOAgent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, state_size, action_size, clip_ratio<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state_size <span style="color:#f92672">=</span> state_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>action_size <span style="color:#f92672">=</span> action_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>clip_ratio <span style="color:#f92672">=</span> clip_ratio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Actorç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>actor <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_build_actor()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Criticç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_build_critic()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>actor_optimizer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adam(learning_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0003</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic_optimizer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adam(learning_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_build_actor</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;æž„å»ºç­–ç•¥ç½‘ç»œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        inputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>(self<span style="color:#f92672">.</span>state_size,))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">64</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(inputs)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">64</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(x)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(self<span style="color:#f92672">.</span>action_size, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>)(x)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>inputs, outputs<span style="color:#f92672">=</span>outputs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_build_critic</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;æž„å»ºä»·å€¼ç½‘ç»œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        inputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Input(shape<span style="color:#f92672">=</span>(self<span style="color:#f92672">.</span>state_size,))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">64</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(inputs)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">64</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)(x)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">1</span>)(x)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>inputs, outputs<span style="color:#f92672">=</span>outputs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_action</span>(self, state):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;èŽ·å–åŠ¨ä½œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        state <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>reshape(state, [<span style="color:#ae81ff">1</span>, self<span style="color:#f92672">.</span>state_size])
</span></span><span style="display:flex;"><span>        probs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>actor<span style="color:#f92672">.</span>predict(state, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        action <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(self<span style="color:#f92672">.</span>action_size, p<span style="color:#f92672">=</span>probs)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> action, probs[action]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compute_advantages</span>(self, rewards, values, next_values, dones):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;è®¡ç®—ä¼˜åŠ¿å‡½æ•°&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        advantages <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros_like(rewards)
</span></span><span style="display:flex;"><span>        last_gae_lam <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> reversed(range(len(rewards))):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> t <span style="color:#f92672">==</span> len(rewards) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                next_non_terminal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> dones[t]
</span></span><span style="display:flex;"><span>                next_values <span style="color:#f92672">=</span> next_values[t]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                next_non_terminal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> dones[t]
</span></span><span style="display:flex;"><span>                next_values <span style="color:#f92672">=</span> values[t <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            delta <span style="color:#f92672">=</span> rewards[t] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.99</span> <span style="color:#f92672">*</span> next_values <span style="color:#f92672">*</span> next_non_terminal <span style="color:#f92672">-</span> values[t]
</span></span><span style="display:flex;"><span>            advantages[t] <span style="color:#f92672">=</span> last_gae_lam <span style="color:#f92672">=</span> delta <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.99</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.95</span> <span style="color:#f92672">*</span> next_non_terminal <span style="color:#f92672">*</span> last_gae_lam
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> advantages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(self, states, actions, old_probs, advantages, returns):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;PPOè®­ç»ƒ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>GradientTape() <span style="color:#66d9ef">as</span> tape:
</span></span><span style="display:flex;"><span>            probs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>actor(states)
</span></span><span style="display:flex;"><span>            values <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>critic(states)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># è®¡ç®—ç­–ç•¥æŸå¤±</span>
</span></span><span style="display:flex;"><span>            new_probs <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>gather(probs, actions, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, batch_dims<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            ratio <span style="color:#f92672">=</span> new_probs <span style="color:#f92672">/</span> old_probs
</span></span><span style="display:flex;"><span>            clipped_ratio <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>clip_by_value(ratio, <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>clip_ratio, <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>clip_ratio)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            policy_loss <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>tf<span style="color:#f92672">.</span>reduce_mean(tf<span style="color:#f92672">.</span>minimum(ratio <span style="color:#f92672">*</span> advantages, clipped_ratio <span style="color:#f92672">*</span> advantages))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># è®¡ç®—ä»·å€¼æŸå¤±</span>
</span></span><span style="display:flex;"><span>            value_loss <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(tf<span style="color:#f92672">.</span>square(returns <span style="color:#f92672">-</span> values))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># æ€»æŸå¤±</span>
</span></span><span style="display:flex;"><span>            loss <span style="color:#f92672">=</span> policy_loss <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> value_loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># æ›´æ–°Actor</span>
</span></span><span style="display:flex;"><span>        actor_grads <span style="color:#f92672">=</span> tape<span style="color:#f92672">.</span>gradient(policy_loss, self<span style="color:#f92672">.</span>actor<span style="color:#f92672">.</span>trainable_variables)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>actor_optimizer<span style="color:#f92672">.</span>apply_gradients(zip(actor_grads, self<span style="color:#f92672">.</span>actor<span style="color:#f92672">.</span>trainable_variables))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># æ›´æ–°Critic</span>
</span></span><span style="display:flex;"><span>        critic_grads <span style="color:#f92672">=</span> tape<span style="color:#f92672">.</span>gradient(value_loss, self<span style="color:#f92672">.</span>critic<span style="color:#f92672">.</span>trainable_variables)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic_optimizer<span style="color:#f92672">.</span>apply_gradients(zip(critic_grads, self<span style="color:#f92672">.</span>critic<span style="color:#f92672">.</span>trainable_variables))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> loss
</span></span></code></pre></div><h2 id="-æ¨¡åž‹éƒ¨ç½²">ðŸš€ æ¨¡åž‹éƒ¨ç½²</h2>
<h3 id="tensorflow-serving">TensorFlow Serving</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ä¿å­˜æ¨¡åž‹ç”¨äºŽServing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºæ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Sequential([
</span></span><span style="display:flex;"><span>    tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">64</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,)),
</span></span><span style="display:flex;"><span>    tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sigmoid&#39;</span>)
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®­ç»ƒæ¨¡åž‹ï¼ˆç¤ºä¾‹ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># model.fit(...)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿å­˜æ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#39;model/1&#39;</span>)  <span style="color:#75715e"># TensorFlow Servingæ ¼å¼</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨TensorFlow Serving</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tensorflow_model_server </span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    --rest_api_port=8501 </span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    --model_name=my_model </span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    --model_base_path=/path/to/model
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨REST APIè¿›è¡Œé¢„æµ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;signature_name&#34;</span>: <span style="color:#e6db74">&#34;serving_default&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;inputs&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;dense_input&#34;</span>: [[<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">2.0</span>, <span style="color:#ae81ff">3.0</span>, <span style="color:#ae81ff">4.0</span>, <span style="color:#ae81ff">5.0</span>, <span style="color:#ae81ff">6.0</span>, <span style="color:#ae81ff">7.0</span>, <span style="color:#ae81ff">8.0</span>, <span style="color:#ae81ff">9.0</span>, <span style="color:#ae81ff">10.0</span>]]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;content-type&#34;</span>: <span style="color:#e6db74">&#34;application/json&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#39;http://localhost:8501/v1/models/my_model:predict&#39;</span>, data<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>print(response<span style="color:#f92672">.</span>json())
</span></span></code></pre></div><h3 id="tensorflow-liteè½¬æ¢å’Œéƒ¨ç½²">TensorFlow Liteè½¬æ¢å’Œéƒ¨ç½²</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># è½¬æ¢ä¸ºTensorFlow Lite</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">convert_to_tflite</span>(model, quantization<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;float32&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;è½¬æ¢ä¸ºTensorFlow Liteæ ¼å¼&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åˆ›å»ºè½¬æ¢å™¨</span>
</span></span><span style="display:flex;"><span>    converter <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>lite<span style="color:#f92672">.</span>TFLiteConverter<span style="color:#f92672">.</span>from_keras_model(model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> quantization <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;float16&#39;</span>:
</span></span><span style="display:flex;"><span>        converter<span style="color:#f92672">.</span>optimizations <span style="color:#f92672">=</span> [tf<span style="color:#f92672">.</span>lite<span style="color:#f92672">.</span>Optimize<span style="color:#f92672">.</span>DEFAULT]
</span></span><span style="display:flex;"><span>        converter<span style="color:#f92672">.</span>target_spec<span style="color:#f92672">.</span>supported_types <span style="color:#f92672">=</span> [tf<span style="color:#f92672">.</span>float16]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> quantization <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;int8&#39;</span>:
</span></span><span style="display:flex;"><span>        converter<span style="color:#f92672">.</span>optimizations <span style="color:#f92672">=</span> [tf<span style="color:#f92672">.</span>lite<span style="color:#f92672">.</span>Optimize<span style="color:#f92672">.</span>DEFAULT]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># æä¾›ä»£è¡¨æ€§æ•°æ®é›†ç”¨äºŽé‡åŒ–</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">representative_data_gen</span>():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> input_value <span style="color:#f92672">in</span> tf<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>Dataset<span style="color:#f92672">.</span>from_tensor_slices(x_train)<span style="color:#f92672">.</span>batch(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">yield</span> [input_value]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        converter<span style="color:#f92672">.</span>representative_dataset <span style="color:#f92672">=</span> representative_data_gen
</span></span><span style="display:flex;"><span>        converter<span style="color:#f92672">.</span>target_spec<span style="color:#f92672">.</span>supported_ops <span style="color:#f92672">=</span> [tf<span style="color:#f92672">.</span>lite<span style="color:#f92672">.</span>OpsSet<span style="color:#f92672">.</span>TFLITE_BUILTINS_INT8]
</span></span><span style="display:flex;"><span>        converter<span style="color:#f92672">.</span>inference_input_type <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>int8
</span></span><span style="display:flex;"><span>        converter<span style="color:#f92672">.</span>inference_output_type <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>int8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># è½¬æ¢æ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>    tflite_model <span style="color:#f92672">=</span> converter<span style="color:#f92672">.</span>convert()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ä¿å­˜æ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;model_</span><span style="color:#e6db74">{</span>quantization<span style="color:#e6db74">}</span><span style="color:#e6db74">.tflite&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(tflite_model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tflite_model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è½¬æ¢ä¸åŒç²¾åº¦ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> create_model()  <span style="color:#75715e"># å‡è®¾çš„æ¨¡åž‹åˆ›å»ºå‡½æ•°</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è½¬æ¢ä¸ºä¸åŒç²¾åº¦</span>
</span></span><span style="display:flex;"><span>convert_to_tflite(model, <span style="color:#e6db74">&#39;float32&#39;</span>)
</span></span><span style="display:flex;"><span>convert_to_tflite(model, <span style="color:#e6db74">&#39;float16&#39;</span>)
</span></span><span style="display:flex;"><span>convert_to_tflite(model, <span style="color:#e6db74">&#39;int8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¯„ä¼°æ¨¡åž‹å¤§å°å’Œæ€§èƒ½</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> precision <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;float32&#39;</span>, <span style="color:#e6db74">&#39;float16&#39;</span>, <span style="color:#e6db74">&#39;int8&#39;</span>]:
</span></span><span style="display:flex;"><span>    model_path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;model_</span><span style="color:#e6db74">{</span>precision<span style="color:#e6db74">}</span><span style="color:#e6db74">.tflite&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(model_path):
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>getsize(model_path) <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span>  <span style="color:#75715e"># MB</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>precision<span style="color:#e6db74">}</span><span style="color:#e6db74">æ¨¡åž‹å¤§å°: </span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> MB&#34;</span>)
</span></span></code></pre></div><h3 id="tensorflowjsè½¬æ¢">TensorFlow.jsè½¬æ¢</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># è½¬æ¢ä¸ºTensorFlow.jsæ ¼å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflowjs <span style="color:#66d9ef">as</span> tfjs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿å­˜ä¸ºTensorFlow.jsæ ¼å¼</span>
</span></span><span style="display:flex;"><span>tfjs<span style="color:#f92672">.</span>converters<span style="color:#f92672">.</span>save_keras_model(model, <span style="color:#e6db74">&#39;tfjs_model/&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æˆ–è€…è½¬æ¢ä¸ºåˆ†å±‚æ ¼å¼</span>
</span></span><span style="display:flex;"><span>tfjs<span style="color:#f92672">.</span>converters<span style="color:#f92672">.</span>save_keras_model(model, <span style="color:#e6db74">&#39;tfjs_model/&#39;</span>, quantization_dtype<span style="color:#f92672">=</span>tfjs<span style="color:#f92672">.</span>quantization_config<span style="color:#f92672">.</span>INT8)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># HTMLä¸­ä½¿ç”¨æ¨¡åž‹</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;script src=&#34;https://cdn.jsdelivr.net/npm/@tensorflow/tfjs&#34;&gt;&lt;/script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        async function loadModel() {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            // åŠ è½½æ¨¡åž‹
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            const model = await tf.loadLayersModel(&#39;tfjs_model/model.json&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            // å‡†å¤‡è¾“å…¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            const input = tf.tensor2d([[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]]);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            // è¿›è¡Œé¢„æµ‹
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            const prediction = model.predict(input);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            prediction.print();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        loadModel();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id="-ç”Ÿäº§çŽ¯å¢ƒæœ€ä½³å®žè·µ">ðŸ“Š ç”Ÿäº§çŽ¯å¢ƒæœ€ä½³å®žè·µ</h2>
<h3 id="æ¨¡åž‹ç›‘æŽ§">æ¨¡åž‹ç›‘æŽ§</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ModelMonitor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, model, metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>, <span style="color:#e6db74">&#39;latency&#39;</span>, <span style="color:#e6db74">&#39;throughput&#39;</span>]):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> model
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>metrics <span style="color:#f92672">=</span> metrics
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>predictions <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>true_labels <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>latencies <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_with_monitoring</span>(self, inputs, true_labels<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;å¸¦ç›‘æŽ§çš„é¢„æµ‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># è¿›è¡Œé¢„æµ‹</span>
</span></span><span style="display:flex;"><span>        predictions <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>predict(inputs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        latency <span style="color:#f92672">=</span> end_time <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># è®°å½•æŒ‡æ ‡</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>latencies<span style="color:#f92672">.</span>append(latency)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>predictions<span style="color:#f92672">.</span>extend(predictions)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> true_labels <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>true_labels<span style="color:#f92672">.</span>extend(true_labels)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> predictions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_report</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;ç”Ÿæˆç›‘æŽ§æŠ¥å‘Š&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        report <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>latencies:
</span></span><span style="display:flex;"><span>            report[<span style="color:#e6db74">&#39;avg_latency&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(self<span style="color:#f92672">.</span>latencies)
</span></span><span style="display:flex;"><span>            report[<span style="color:#e6db74">&#39;p95_latency&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>percentile(self<span style="color:#f92672">.</span>latencies, <span style="color:#ae81ff">95</span>)
</span></span><span style="display:flex;"><span>            report[<span style="color:#e6db74">&#39;throughput&#39;</span>] <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>latencies) <span style="color:#f92672">/</span> sum(self<span style="color:#f92672">.</span>latencies)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>true_labels <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>predictions:
</span></span><span style="display:flex;"><span>            predictions <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(self<span style="color:#f92672">.</span>predictions)
</span></span><span style="display:flex;"><span>            true_labels <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(self<span style="color:#f92672">.</span>true_labels)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(predictions<span style="color:#f92672">.</span>shape) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                pred_classes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(predictions, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                true_classes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(true_labels, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                pred_classes <span style="color:#f92672">=</span> (predictions <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.5</span>)<span style="color:#f92672">.</span>astype(int)
</span></span><span style="display:flex;"><span>                true_classes <span style="color:#f92672">=</span> true_labels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            report[<span style="color:#e6db74">&#39;accuracy&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(pred_classes <span style="color:#f92672">==</span> true_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> report
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨æ¨¡åž‹ç›‘æŽ§</span>
</span></span><span style="display:flex;"><span>monitor <span style="color:#f92672">=</span> ModelMonitor(model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¨¡æ‹Ÿç”Ÿäº§çŽ¯å¢ƒé¢„æµ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    test_input <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>    true_label <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    prediction <span style="color:#f92672">=</span> monitor<span style="color:#f92672">.</span>predict_with_monitoring(test_input, true_label)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”ŸæˆæŠ¥å‘Š</span>
</span></span><span style="display:flex;"><span>report <span style="color:#f92672">=</span> monitor<span style="color:#f92672">.</span>generate_report()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;æ¨¡åž‹ç›‘æŽ§æŠ¥å‘Š:&#34;</span>, report)
</span></span></code></pre></div><h3 id="abæµ‹è¯•æ¡†æž¶">A/Bæµ‹è¯•æ¡†æž¶</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ABTestFramework</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, model_a, model_b, traffic_split<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>model_a <span style="color:#f92672">=</span> model_a
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>model_b <span style="color:#f92672">=</span> model_b
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>traffic_split <span style="color:#f92672">=</span> traffic_split
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>model_a_metrics <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>model_b_metrics <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict</span>(self, inputs, true_labels<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;A/Bæµ‹è¯•é¢„æµ‹&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i, (input_data, true_label) <span style="color:#f92672">in</span> enumerate(zip(inputs, true_labels <span style="color:#f92672">or</span> [])):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># éšæœºåˆ†é…æµé‡</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>random() <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>traffic_split:
</span></span><span style="display:flex;"><span>                model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model_a
</span></span><span style="display:flex;"><span>                model_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model_b
</span></span><span style="display:flex;"><span>                model_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># è¿›è¡Œé¢„æµ‹</span>
</span></span><span style="display:flex;"><span>            prediction <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(np<span style="color:#f92672">.</span>expand_dims(input_data, <span style="color:#ae81ff">0</span>))[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            results<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;model&#39;</span>: model_name,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;prediction&#39;</span>: prediction,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;true_label&#39;</span>: true_label
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> results
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">evaluate_models</span>(self, results):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;è¯„ä¼°æ¨¡åž‹æ€§èƒ½&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        model_a_results <span style="color:#f92672">=</span> [r <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> results <span style="color:#66d9ef">if</span> r[<span style="color:#e6db74">&#39;model&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;A&#39;</span>]
</span></span><span style="display:flex;"><span>        model_b_results <span style="color:#f92672">=</span> [r <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> results <span style="color:#66d9ef">if</span> r[<span style="color:#e6db74">&#39;model&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;B&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_metrics</span>(results):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> results:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            predictions <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([r[<span style="color:#e6db74">&#39;prediction&#39;</span>] <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> results])
</span></span><span style="display:flex;"><span>            true_labels <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([r[<span style="color:#e6db74">&#39;true_label&#39;</span>] <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> results])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            pred_classes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(predictions, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            true_classes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(true_labels, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            accuracy <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(pred_classes <span style="color:#f92672">==</span> true_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;accuracy&#39;</span>: accuracy, <span style="color:#e6db74">&#39;sample_size&#39;</span>: len(results)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        metrics_a <span style="color:#f92672">=</span> calculate_metrics(model_a_results)
</span></span><span style="display:flex;"><span>        metrics_b <span style="color:#f92672">=</span> calculate_metrics(model_b_results)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;model_a&#39;</span>: metrics_a, <span style="color:#e6db74">&#39;model_b&#39;</span>: metrics_b}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨A/Bæµ‹è¯•æ¡†æž¶</span>
</span></span><span style="display:flex;"><span>ab_test <span style="color:#f92672">=</span> ABTestFramework(model_v1, model_v2, traffic_split<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¨¡æ‹ŸA/Bæµ‹è¯•</span>
</span></span><span style="display:flex;"><span>test_inputs <span style="color:#f92672">=</span> [np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand(<span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000</span>)]
</span></span><span style="display:flex;"><span>test_labels <span style="color:#f92672">=</span> [np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">=</span> ab_test<span style="color:#f92672">.</span>predict(test_inputs, test_labels)
</span></span><span style="display:flex;"><span>metrics <span style="color:#f92672">=</span> ab_test<span style="color:#f92672">.</span>evaluate_models(results)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;A/Bæµ‹è¯•ç»“æžœ:&#34;</span>, metrics)
</span></span></code></pre></div><h2 id="-å­¦ä¹ èµ„æº">ðŸ“š å­¦ä¹ èµ„æº</h2>
<h3 id="å®˜æ–¹æ–‡æ¡£">å®˜æ–¹æ–‡æ¡£</h3>
<ul>
<li><a href="https://www.tensorflow.org/tfx/guide/serving">TensorFlow Servingæ–‡æ¡£</a></li>
<li><a href="https://www.tensorflow.org/lite">TensorFlow Liteæ–‡æ¡£</a></li>
<li><a href="https://www.tensorflow.org/js">TensorFlow.jsæ–‡æ¡£</a></li>
</ul>
<h3 id="å´æ©è¾¾è¯¾ç¨‹">å´æ©è¾¾è¯¾ç¨‹</h3>
<ul>
<li>æ·±åº¦å­¦ä¹ è¯¾ç¨‹ä¸­å…³äºŽå®žé™…åº”ç”¨çš„éƒ¨åˆ†</li>
</ul>
<h3 id="ç»å…¸é¡¹ç›®">ç»å…¸é¡¹ç›®</h3>
<ul>
<li><a href="https://github.com/tensorflow/models">TensorFlow Models</a> - å®˜æ–¹æ¨¡åž‹åº“</li>
<li><a href="https://tfhub.dev/">TensorFlow Hub</a> - é¢„è®­ç»ƒæ¨¡åž‹ä»“åº“</li>
<li><a href="https://www.kaggle.com/competitions">Kaggleç«žèµ›</a> - å®žè·µé¡¹ç›®</li>
</ul>
<h2 id="-éƒ¨ç½²æœ€ä½³å®žè·µ">ðŸ”§ éƒ¨ç½²æœ€ä½³å®žè·µ</h2>
<h3 id="å®¹å™¨åŒ–éƒ¨ç½²">å®¹å™¨åŒ–éƒ¨ç½²</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># Dockerfile</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">tensorflow/serving:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> model/ /models/my_model<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> MODEL_NAME<span style="color:#f92672">=</span>my_model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨å‘½ä»¤</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;tensorflow_model_server&#34;</span>, <span style="color:#e6db74">&#34;--rest_api_port=8501&#34;</span>, <span style="color:#e6db74">&#34;--model_name=my_model&#34;</span>, <span style="color:#e6db74">&#34;--model_base_path=/models/my_model&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="æ¨¡åž‹ç‰ˆæœ¬ç®¡ç†">æ¨¡åž‹ç‰ˆæœ¬ç®¡ç†</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># æ¨¡åž‹ç‰ˆæœ¬ç®¡ç†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ModelVersionManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, model_base_path):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>model_base_path <span style="color:#f92672">=</span> model_base_path
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>versions <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_model_version</span>(self, model, version, metadata<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;ä¿å­˜æ¨¡åž‹ç‰ˆæœ¬&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        version_path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>model_base_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ä¿å­˜æ¨¡åž‹</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">.</span>save(version_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ä¿å­˜å…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> metadata:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>version_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/metadata.json&#34;</span>, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                json<span style="color:#f92672">.</span>dump(metadata, f)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>versions[version] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;path&#39;</span>: version_path,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;metadata&#39;</span>: metadata,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;timestamp&#39;</span>: time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_model_version</span>(self, version):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;åŠ è½½æ¨¡åž‹ç‰ˆæœ¬&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> version <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>versions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;ç‰ˆæœ¬ </span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74"> ä¸å­˜åœ¨&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        version_path <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>versions[version][<span style="color:#e6db74">&#39;path&#39;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>load_model(version_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_versions</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;åˆ—å‡ºç‰ˆæœ¬&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> list(self<span style="color:#f92672">.</span>versions<span style="color:#f92672">.</span>keys())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rollback</span>(self, version):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;å›žæ»šåˆ°æŒ‡å®šç‰ˆæœ¬&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>load_model_version(version)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>save_model_version(model, <span style="color:#e6db74">&#39;current&#39;</span>, {<span style="color:#e6db74">&#39;rollback_from&#39;</span>: version})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨ç‰ˆæœ¬ç®¡ç†å™¨</span>
</span></span><span style="display:flex;"><span>version_manager <span style="color:#f92672">=</span> ModelVersionManager(<span style="color:#e6db74">&#39;./models&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿å­˜ä¸åŒç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, model <span style="color:#f92672">in</span> enumerate([model_v1, model_v2, model_v3]):
</span></span><span style="display:flex;"><span>    version_manager<span style="color:#f92672">.</span>save_model_version(
</span></span><span style="display:flex;"><span>        model,
</span></span><span style="display:flex;"><span>        version<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;v</span><span style="color:#e6db74">{</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        metadata<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;æ¨¡åž‹ç‰ˆæœ¬</span><span style="color:#e6db74">{</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;accuracy&#39;</span>: <span style="color:#ae81ff">0.95</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">*</span><span style="color:#ae81ff">0.01</span>}
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><hr>
<p><em>æœ€è¿‘æ›´æ–°: {{ .Lastmod.Format &ldquo;2006-01-02&rdquo; }}</em></p>

      
      <div class="post-separator">------------------------------------------------------------------------</div>
      
    </div>
    <div class="post-footer">
      
      <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      <div class="busuanzi-container">
        <span id="busuanzi_container_page_pv">--æœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡--</span>
      </div>
      
      
      <script src="https://utteranc.es/client.js"
        repo="makkichan947/makkichan947.github.io"
        issue-term="pathname"
        label="Utterances"
        theme="github-dark"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </article>

    </main>
  </body>
</html>
